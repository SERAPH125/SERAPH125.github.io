<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å‘¨é‡‘éœç”·å‹">
    <title>æ¸©é¦¨ç›¸å†Œ - å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ â¤ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link rel="stylesheet" href="common.css">
</head>
<body>
<div class="bg-shape shape-1"></div>
<div class="bg-shape shape-2"></div>
<div id="sakura-container"></div>

<div class="container">
    <header>
        <h1>ğŸ–¼ï¸ æ¸©é¦¨ç›¸å†Œ <span class="version-tag">V3.1</span></h1>
        <div class="love-days">å·²ç»è®¤è¯† <span id="days-count">0</span> å¤©å•¦ ğŸ’•</div>
    </header>

    <div class="nav-tabs">
        <a href="index.html" class="nav-btn">ğŸ  ä¸»é¡µ</a>
        <a href="wishlist.html" class="nav-btn">âœ¨ æ„¿æœ›</a>
        <a href="album.html" class="nav-btn active">ğŸ–¼ï¸ ç›¸å†Œ</a>
        <a href="shop.html" class="nav-btn">ğŸ å•†åº—</a>
        <a href="settings.html" class="nav-btn">âš™ï¸ è®¾ç½®</a>
    </div>

    <div class="album-grid" id="album-list"></div>
    <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#999;">
        è®°å½•æ¯ä¸€ä¸ªå¿ƒåŠ¨ç¬é—´ â¤ï¸
    </div>
</div>

<!-- æ·»åŠ ç…§ç‰‡å¼¹çª— -->
<div class="modal-overlay" id="add-photo-modal" style="display:none;">
    <div class="modal" style="width:85%; max-width:320px; padding:20px;">
        <h3 style="text-align:center; margin:0 0 15px 0;">ğŸ“¸ æ·»åŠ ç¾å¥½æ—¶å…‰</h3>
        <input type="text" id="photo-url-input" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥ (æ¨è)" oninput="app.previewUrl()" style="margin-bottom:10px;">
        <div style="text-align:center; color:#999; font-size:0.8rem; margin-bottom:10px;">- æˆ–è€… -</div>
        <label for="photo-file-input" class="btn" style="background:#f0f0f0; color:#555; margin-bottom:10px; cursor:pointer;">
            ğŸ“‚ ä»ç›¸å†Œé€‰æ‹© (è‡ªåŠ¨å‹ç¼©)
        </label>
        <input type="file" id="photo-file-input" accept="image/*" style="display:none;" onchange="app.handleFileSelect(this)">
        <div id="photo-preview-area">
            <span style="color:#ccc; font-size:0.8rem;">å›¾ç‰‡é¢„è§ˆåŒºåŸŸ</span>
            <img id="photo-preview-img">
        </div>
        <input type="text" id="photo-location" placeholder="ğŸ“ åœ¨å“ªé‡Œæ‹çš„ï¼Ÿ(ä¾‹å¦‚: ä¸Šæµ·Â·å¤–æ»©)" style="margin-top:10px;">
        <input type="text" id="photo-caption" placeholder="ğŸ“ å†™ä¸€å¥ç”œç”œçš„è¯å§... (é€‰å¡«)" style="margin-top:10px;">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('add-photo-modal').style.display='none'" style="flex:1; padding:12px; border:none; background:#f0f0f0; border-radius:12px;">å–æ¶ˆ</button>
            <button onclick="app.confirmAddPhoto()" style="flex:1; padding:12px; border:none; background:var(--accent-pink); color:white; border-radius:12px;">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- å¤§å›¾æŸ¥çœ‹ -->
<div class="modal-overlay" id="lightbox-modal" style="display:none; background:rgba(0,0,0,0.85);" onclick="this.style.display='none'">
    <img id="lightbox-img" src="" onclick="event.stopPropagation()">
</div>

<script src="common.js"></script>
<script>
Object.assign(app, {
    init() {
        this.initCommon();
        this.render();
    },

    render() {
        const albumList = document.getElementById('album-list');
        if (!albumList) return;
        
        let albumHtml = `
            <div class="add-photo-card" onclick="app.addPhotoUI()">
                <div style="font-size:2rem;">ğŸ“·</div>
                <div style="font-size:0.8rem; margin-top:5px;">æ·»åŠ ç…§ç‰‡</div>
            </div>
        `;
        
        if (this.data.album && this.data.album.length > 0) {
            albumHtml += this.data.album.map(photo => `
                <div class="polaroid" onclick="app.showLightbox('${photo.url.replace(/'/g, "\\'")}')">
                    <div class="btn-del-photo" onclick="event.stopPropagation(); app.deletePhoto(${photo.id})">Ã—</div>
                    <div class="photo-frame">
                        <img src="${photo.url.replace(/"/g, '&quot;')}" class="photo-img" loading="lazy">
                    </div>
                    <div class="photo-caption">${(photo.caption || 'â¤ï¸ ç¾å¥½æ—¶å…‰').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    <div class="photo-meta">
                        ${photo.location ? `<div class="location-badge">ğŸ“ ${photo.location.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : '<div></div>'}
                        <div class="photo-date">${photo.date || ''}</div>
                    </div>
                </div>
            `).join('');
        }
        albumList.innerHTML = albumHtml;
    },

    addPhotoUI() {
        document.getElementById('add-photo-modal').style.display = 'flex';
        this.tempPhotoData = null;
        document.getElementById('photo-url-input').value = '';
        document.getElementById('photo-preview-img').style.display = 'none';
        document.getElementById('photo-caption').value = '';
        document.getElementById('photo-location').value = '';
    },

    previewUrl() {
        const url = document.getElementById('photo-url-input').value.trim();
        if (url) {
            this.tempPhotoData = url;
            const img = document.getElementById('photo-preview-img');
            img.src = url;
            img.style.display = 'block';
        }
    },

    handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            this.compressImage(file, (base64) => {
                this.tempPhotoData = base64;
                const img = document.getElementById('photo-preview-img');
                img.src = base64;
                img.style.display = 'block';
                document.getElementById('photo-url-input').value = '';
            });
        }
    },

    compressImage(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600;
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                callback(dataUrl);
            };
        };
    },

    confirmAddPhoto() {
        try {
            if (!this.tempPhotoData) {
                const url = document.getElementById('photo-url-input').value.trim();
                if (url) this.tempPhotoData = url;
                if (!this.tempPhotoData) return alert('è¯·å…ˆè¾“å…¥å›¾ç‰‡é“¾æ¥æˆ–é€‰æ‹©å›¾ç‰‡å“¦ï¼');
            }
            const caption = document.getElementById('photo-caption').value.trim();
            const location = document.getElementById('photo-location').value.trim();
            
            if (this.tempPhotoData.length > 500000) {
                if(!confirm('è¿™å¼ å›¾ç‰‡å¯èƒ½æœ‰ç‚¹å¤§ï¼Œä¼šå½±å“åŒæ­¥é€Ÿåº¦ï¼Œç¡®å®šè¦æ·»åŠ å—ï¼Ÿ')) return;
            }

            if (!this.data.album || !Array.isArray(this.data.album)) {
                this.data.album = [];
            }

            this.data.album.unshift({
                id: Date.now(),
                url: this.tempPhotoData,
                caption: caption,
                location: location,
                date: new Date().toLocaleDateString()
            });

            if (this.data.album.length > 40) {
                this.showToast('ç›¸å†Œå¥½åƒæ»¡äº† (40å¼ )ï¼Œæ—§ç…§ç‰‡è¢«æŒ¤æ‰äº†... ğŸ˜¢');
                this.data.album.pop();
            }

            this.saveData();
            document.getElementById('add-photo-modal').style.display = 'none';
            this.showToast('ç…§ç‰‡æ·»åŠ æˆåŠŸï¼ç¾å¥½+1 â¤ï¸');
        } catch (e) {
            console.error(e);
            alert('å‡ºé”™äº†ï¼š' + e.message);
        }
    },

    deletePhoto(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç¾å¥½å›å¿†å—ï¼ŸğŸ¥º')) {
            this.data.album = this.data.album.filter(p => p.id !== id);
            this.saveData();
            this.showToast('ç…§ç‰‡å·²åˆ é™¤');
        }
    },

    showLightbox(url) {
        const modal = document.getElementById('lightbox-modal');
        const img = document.getElementById('lightbox-img');
        img.src = url;
        modal.style.display = 'flex';
    }
});

app.init();
</script>
</body>
</html>

