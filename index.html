<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å‘¨é‡‘éœç”·å‹">
    <title>å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ V3.4 äº‘åŒæ­¥ç‰ˆ â¤ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        /* ä¸»é¡µç‰¹å®šæ ·å¼ */
        .btn-del-photo {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .signin-status-bar {
            background: rgba(255,255,255,0.4);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .signin-avatar {
            width: 30px; height: 30px;
            background: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }
        .signin-avatar.done::after {
            content: 'âœ“';
            position: absolute;
            bottom: -2px; right: -2px;
            background: var(--success);
            color: white;
            font-size: 8px;
            width: 12px; height: 12px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid white;
        }
    </style>
</head>
<body>
<!-- èƒŒæ™¯è£…é¥° -->
<div class="bg-shape shape-1"></div>
<div class="bg-shape shape-2"></div>
<div id="sakura-container"></div>

<div class="container">
    <header>
        <h1>å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ <span class="version-tag">V3.4</span></h1>
        <div class="love-days">å·²ç»è®¤è¯† <span id="days-count">0</span> å¤©å•¦ ğŸ’•</div>
    </header>
    
    <div id="daily-quote" class="daily-quote">åŠ è½½ä¸­...</div>

    <!-- çºªå¿µæ—¥å¡ç‰‡ (V3.4) -->
    <div class="anniversary-card" onclick="app.editAnniversary()" style="background:rgba(255,255,255,0.6); padding:15px; border-radius:15px; margin-bottom:20px; text-align:center; border:1px solid rgba(255,255,255,0.5); cursor:pointer;">
        <div style="font-size:0.9rem; color:var(--text-light); margin-bottom:5px;">ğŸ“… ä¸‹ä¸€ä¸ªé‡è¦æ—¥å­</div>
        <div id="anniversary-content">
            <span style="color:var(--text-light); font-size:0.9rem;">(ç‚¹å‡»è®¾ç½®çºªå¿µæ—¥)</span>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <div class="nav-tabs">
        <a href="index.html" class="nav-btn active">ğŸ  ä¸»é¡µ</a>
        <a href="wishlist.html" class="nav-btn">âœ¨ æ„¿æœ›</a>
        <a href="album.html" class="nav-btn">ğŸ–¼ï¸ ç›¸å†Œ</a>
        <a href="shop.html" class="nav-btn">ğŸ å•†åº—</a>
        <a href="settings.html" class="nav-btn">âš™ï¸ è®¾ç½®</a>
    </div>

    <!-- ä¸»é¡µå†…å®¹ -->
    <div class="score-card">
        <div class="home-streak-badge" id="home-streak" onclick="app.showSignInModal(true)">
            <span>ğŸ”¥</span> <span id="streak-num">0</span> å¤©
        </div>
        <div class="score-content">
            <div class="score-title">Current Score</div>
            <div class="score-value" id="score-display">0</div>
            <div class="rank-badge" id="rank-display">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- åŒäººç­¾åˆ°çŠ¶æ€æ  -->
    <div class="signin-status-bar" id="signin-status-bar">
        <div style="display:flex; align-items:center; gap:8px;">
            <div class="signin-avatar" id="avatar-boy">ğŸ‘¦</div>
            <div class="signin-avatar" id="avatar-girl">ğŸ‘§</div>
        </div>
        <div id="signin-text-status">ç­‰å¾…ç­¾åˆ°...</div>
    </div>

    <!-- ç”œåº¦å­˜é’±ç½ -->
    <div class="sweetness-card">
        <h3>ğŸ¬ å°å‘¨çš„ç”œåº¦å­˜é’±ç½</h3>
        <div class="sweetness-display"><span id="sweetness-val">0</span> ğŸ¬</div>
        <div class="sweetness-progress-bg">
            <div class="sweetness-progress-fill" id="sweetness-bar" style="width: 0%"></div>
        </div>
        <button class="btn-record-sweet" onclick="app.showSweetModal()">ğŸ’– è®°å½•å¿ƒåŠ¨ç¬é—´</button>
    </div>

    <!-- ç”Ÿç†æœŸå¡ç‰‡ -->
    <div class="period-card" onclick="location.href='settings.html'">
        <h3>ğŸ©¸ å§¨å¦ˆåŠ©æ‰‹</h3>
        <div id="period-display">
            <div class="period-info">ä¸Šæ¬¡è®°å½•ï¼šæš‚æ— æ•°æ®</div>
            <div class="period-info">è¯·å»è®¾ç½®é¡µè®°å½•æ—¥æœŸå“¦ ~</div>
        </div>
    </div>

    <input type="text" id="reason-input" placeholder="âœ¨ è®°å½•æ¯ä¸€ä¸ªå¿ƒåŠ¨ç¬é—´...">

    <div class="action-buttons">
        <button class="btn btn-add" onclick="app.addScore()">
            <span>ğŸ’–</span> ç”œèœœåŠ åˆ†
        </button>
        <button class="btn btn-sub" onclick="app.tryDeductScore()">
            <span>ğŸ’”</span> æ®‹å¿å‡åˆ†
        </button>
    </div>

    <button class="btn btn-random" onclick="app.randomTask()">ğŸ² éšæœºä»»åŠ¡ (èµšå–ç§¯åˆ†)</button>
</div>

<!-- æ±‚é¥¶å¼¹çª— -->
<div class="modal-overlay" id="mercy-modal" style="display:none;">
    <div class="modal">
        <span style="font-size:3rem; display:block; margin-bottom:15px; animation: bounce 1s infinite;">ğŸ¥º</span>
        <h3 id="mercy-title" style="margin:0 0 10px 0; color:var(--text-main);">æ‰‹ä¸‹ç•™æƒ…é¸­ï¼</h3>
        <p id="mercy-text" style="color:#666; margin-bottom:20px; line-height:1.5;">å®å®æˆ‘é”™äº†...</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="app.forgive()" style="background:linear-gradient(135deg, #a8edea, #fed6e3); color:#5e4b56; border:none; padding:12px; border-radius:12px; font-weight:bold;">ğŸ’– åŸè°…ä»– (ä¸æ‰£åˆ†)</button>
            <button onclick="app.confirmDeduct()" style="background:transparent; border:1px solid #ff9a9e; color:#ff9a9e; padding:10px; border-radius:12px;">ğŸ’” å¿…é¡»æ‰£ (æ®‹å¿)</button>
        </div>
    </div>
</div>

<!-- ç­¾åˆ°å¼¹çª— -->
<div class="modal-overlay" id="signin-modal" style="display:none;">
    <div class="modal" style="width:85%; max-width:340px; padding:30px 20px;">
        <div class="signin-header">
            <span class="signin-icon" id="signin-icon">â˜€ï¸</span>
            <h2 class="signin-title" id="signin-title">æ—©å®‰ï¼</h2>
            <div class="signin-subtitle" id="signin-text">æ–°çš„ä¸€å¤©ä¹Ÿè¦å¼€å¿ƒå“¦~</div>
        </div>
        <div class="streak-container">
            <div class="streak-label">Current Streak</div>
            <div class="streak-count"><span id="signin-streak">1</span> DAYS</div>
            <div class="streak-dots" id="streak-dots"></div>
        </div>
        <div class="signin-reward" id="signin-reward-text">
            <span>ğŸ’</span> ç§¯åˆ† +1
        </div>
        <button class="btn-signin" onclick="app.closeSignIn()">å¼€å¯ç¾å¥½ä¸€å¤© âœ¨</button>
    </div>
</div>

    <!-- éšæœºä»»åŠ¡å¼¹çª— -->
    <div class="modal-overlay" id="task-modal" style="display:none;">
        <div class="modal">
            <span style="font-size:3rem; display:block; margin-bottom:15px;">ğŸ</span>
            <h3 style="margin:0 0 10px 0;">éšæœºç”œèœœä»»åŠ¡</h3>
            <p id="task-text" style="color:#666; margin-bottom:20px;">ä»»åŠ¡åŠ è½½ä¸­...</p>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button onclick="app.acceptTask()" style="background:var(--accent-blue); color:white; border:none; padding:12px; border-radius:12px;">ğŸ’ª æ¥ä¸‹ä»»åŠ¡ (+50åˆ†)</button>
                <button onclick="app.closeTask()" style="background:transparent; color:#999; border:none; padding:10px;">ä¸‹æ¬¡ä¸€å®š</button>
            </div>
        </div>
    </div>

    <!-- çºªå¿µæ—¥è®¾ç½®å¼¹çª— (V3.4) -->
    <div class="modal-overlay" id="anniversary-modal" style="display:none;">
        <div class="modal">
            <span style="font-size:3rem; display:block; margin-bottom:15px;">ğŸ“…</span>
            <h3 style="margin:0 0 10px 0;">è®¾ç½®ä¸‹ä¸€ä¸ªçºªå¿µæ—¥</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">ä¾‹å¦‚ï¼šå¥¹çš„ç”Ÿæ—¥ã€æ‹çˆ±ä¸€å‘¨å¹´ç­‰</p>
            
            <input type="text" id="anni-name" placeholder="æ—¥å­åç§° (å¦‚: å®å®ç”Ÿæ—¥)" style="margin-bottom:10px;">
            <input type="date" id="anni-date" style="margin-bottom:15px;">
            
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('anniversary-modal').style.display='none'" style="flex:1; background:#f0f0f0; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
                <button onclick="app.saveAnniversary()" style="flex:1; background:var(--accent-pink); color:white; border:none; padding:10px; border-radius:12px;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç”œåº¦è®°å½•å¼¹çª— -->
<div class="modal-overlay" id="sweet-modal" style="display:none;">
    <div class="modal">
        <span style="font-size:3rem; display:block; margin-bottom:15px;">ğŸ¥°</span>
        <h3 style="margin:0 0 10px 0;">è®°å½•å¥¹çš„å¯çˆ±ç¬é—´</h3>
        <input type="text" id="sweet-reason" placeholder="ä¾‹å¦‚ï¼šç»™æˆ‘å¸¦äº†å¥¶èŒ¶..." style="margin-bottom:15px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="app.confirmSweet(10)" style="background:#ff9a9e; color:white; border:none; padding:10px; border-radius:12px;">æœ‰ç‚¹å¯çˆ± (+10)</button>
            <button onclick="app.confirmSweet(20)" style="background:#ff8fa3; color:white; border:none; padding:10px; border-radius:12px;">è¶…çº§è´´å¿ƒ (+20)</button>
            <button onclick="app.confirmSweet(50)" style="background:#ff758c; color:white; border:none; padding:10px; border-radius:12px;">å¿ƒåŠ¨çˆ†å‡» (+50)</button>
            <button onclick="app.closeSweetModal()" style="background:transparent; color:#999; border:none; padding:10px;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- iOS å®‰è£…æç¤º -->
<div id="ios-install-guide">
    ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„ <span class="ios-guide-icon">åˆ†äº«</span> æŒ‰é’®<br>
    ç„¶åé€‰æ‹© <strong>"æ·»åŠ åˆ°ä¸»å±å¹•"</strong> å³å¯ç”Ÿæˆå›¾æ ‡ â¤ï¸
    <div style="margin-top:10px; font-size:0.8rem; color:#999; cursor:pointer;" onclick="this.parentElement.style.display='none'">[æˆ‘çŸ¥é“äº†]</div>
</div>

<script src="common.js"></script>
<script>
// ä¸»é¡µç‰¹å®šåŠŸèƒ½
Object.assign(app, {
    init() {
        this.initCommon();
        // å»¶è¿Ÿæ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½
        setTimeout(() => {
            this.render();
            this.checkDailySignIn();
        }, 100);
    },

    render() {
        const scoreEl = document.getElementById('score-display');
        const rankEl = document.getElementById('rank-display');
        if (scoreEl) scoreEl.innerText = this.data.score;
        if (rankEl) rankEl.innerText = this.getRank();
        
        // æ¸²æŸ“ç”œåº¦
        const sweetVal = this.data.girlSweetness || 0;
        const sweetEl = document.getElementById('sweetness-val');
        const sweetBar = document.getElementById('sweetness-bar');
        if(sweetEl) sweetEl.innerText = sweetVal;
        if(sweetBar) {
            // è§†è§‰ä¸Šé™è°ƒæ•´ä¸º1000ï¼Œæ–¹ä¾¿æŸ¥çœ‹å¤§é¢ç›®æ ‡çš„è¿›åº¦
            let pct = Math.min(100, (sweetVal / 1000) * 100);
            sweetBar.style.width = `${pct}%`;
        }

        const body = document.body;
        const scoreCard = document.querySelector('.score-card');
        const scoreTitle = document.querySelector('.score-title');

        if (scoreCard && scoreTitle) {
            if (this.data.score < 0) {
                scoreCard.style.background = 'linear-gradient(135deg, #e63946, #000000)';
                scoreTitle.innerText = "âš ï¸ çº¢è‰²è­¦æŠ¥ âš ï¸";
                let grayLevel = Math.min(1, Math.abs(this.data.score) / 500); 
                let brightnessLevel = Math.max(0.4, 1 - (Math.abs(this.data.score) / 800));
                body.style.filter = `grayscale(${grayLevel}) brightness(${brightnessLevel})`;
            } else {
                scoreCard.style.background = 'linear-gradient(135deg, rgba(255, 154, 158, 0.9), rgba(254, 207, 239, 0.9))';
                scoreTitle.innerText = "Current Score";
                body.style.filter = 'none';
            }
        }

        this.renderPeriod();
        this.renderAnniversary();
        this.updateStreakUI();
        this.renderSignInStatus();
    },

    editAnniversary() {
        document.getElementById('anniversary-modal').style.display = 'flex';
        if(this.data.nextAnniversary) {
            document.getElementById('anni-name').value = this.data.nextAnniversary.name || '';
            document.getElementById('anni-date').value = this.data.nextAnniversary.date || '';
        }
    },

    saveAnniversary() {
        const name = document.getElementById('anni-name').value.trim();
        const date = document.getElementById('anni-date').value;
        if(!name || !date) return alert('è¯·å¡«å†™å®Œæ•´å“¦ï¼');
        
        this.data.nextAnniversary = { name, date };
        this.saveData();
        document.getElementById('anniversary-modal').style.display = 'none';
        this.renderAnniversary();
        this.showToast('çºªå¿µæ—¥å·²è®¾ç½®ï¼æœŸå¾…é‚£ä¸€å¤©çš„åˆ°æ¥ï¼ğŸ‰');
    },

    renderAnniversary() {
        const el = document.getElementById('anniversary-content');
        if(!el) return;
        
        if(!this.data.nextAnniversary || !this.data.nextAnniversary.date) {
            el.innerHTML = '<span style="color:var(--text-light); font-size:0.9rem;">(ç‚¹å‡»è®¾ç½®ä¸‹ä¸€ä¸ªé‡è¦æ—¥å­)</span>';
            return;
        }

        const target = new Date(this.data.nextAnniversary.date);
        const today = new Date();
        // æ¸…é™¤æ—¶åˆ†ç§’å½±å“
        target.setHours(0,0,0,0);
        today.setHours(0,0,0,0);
        
        const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        const name = this.data.nextAnniversary.name;

        let html = '';
        if (diff > 0) {
            html = `è·ç¦» <span style="font-weight:bold; color:var(--accent-pink);">${name}</span> è¿˜æœ‰ <span style="font-size:1.5rem; font-weight:bold; color:var(--accent-blue);">${diff}</span> å¤©`;
        } else if (diff === 0) {
            html = `ğŸ‰ ä»Šå¤©æ˜¯ <span style="font-weight:bold; color:var(--accent-pink);">${name}</span> ï¼<br>å¿«å»åº†ç¥å§ï¼`;
        } else {
             html = `<span style="font-weight:bold; color:var(--text-main);">${name}</span> å·²ç»è¿‡å» ${Math.abs(diff)} å¤©å•¦<br><span style="font-size:0.8rem; color:#999;">(ç‚¹å‡»æ›´æ–°ä¸‹ä¸€ä¸ªæ—¥å­)</span>`;
        }
        el.innerHTML = html;
    },

    // æ¸²æŸ“åŒäººç­¾åˆ°çŠ¶æ€
    renderSignInStatus() {
        const todayStr = new Date().toISOString().split('T')[0];
        const boyDone = this.data.lastSignInDate_Boy === todayStr;
        const girlDone = this.data.lastSignInDate_Girl === todayStr;
        
        const boyAvatar = document.getElementById('avatar-boy');
        const girlAvatar = document.getElementById('avatar-girl');
        const statusText = document.getElementById('signin-text-status');

        if(boyDone) boyAvatar.classList.add('done');
        else boyAvatar.classList.remove('done');

        if(girlDone) girlAvatar.classList.add('done');
        else girlAvatar.classList.remove('done');

        // æ–‡å­—æç¤º
        if (boyDone && girlDone) {
            statusText.innerHTML = 'â¤ï¸ åŒäººæ‰“å¡å®Œæˆï¼çœŸæ£’ï¼';
            statusText.style.color = 'var(--accent-pink)';
            statusText.style.fontWeight = 'bold';
        } else {
            const me = this.currentUser === 'boy' ? boyDone : girlDone;
            const partner = this.currentUser === 'boy' ? girlDone : boyDone;
            
            if (!me) {
                statusText.innerText = 'ğŸ‘‹ æ—©å®‰ï¼å¿«æ¥ç­¾åˆ°å§';
            } else if (!partner) {
                statusText.innerText = 'ğŸ‘€ ç­‰å¾…å¦ä¸€åŠç­¾åˆ°...';
            }
        }
    },

    addScore() {
        const reason = document.getElementById('reason-input').value.trim();
        if (!reason) return alert('è¯·å¡«å†™ç”œèœœç†ç”±å“¦ï¼âœ¨');
        this.executeChange(10, reason);
        document.getElementById('reason-input').value = '';
        this.showToast('åŠ åˆ†æˆåŠŸï¼çˆ±ä½ å“Ÿï¼ğŸ˜˜');
    },

    // ç”œåº¦ç›¸å…³æ–¹æ³•
    showSweetModal() {
        document.getElementById('sweet-modal').style.display = 'flex';
        document.getElementById('sweet-reason').value = '';
        document.getElementById('sweet-reason').focus();
    },
    
    closeSweetModal() {
        document.getElementById('sweet-modal').style.display = 'none';
    },

    confirmSweet(amount) {
        let reason = document.getElementById('sweet-reason').value.trim();
        if(!reason) {
            if(amount === 10) reason = "ä»Šå¤©æœ‰ç‚¹å¯çˆ±";
            else if(amount === 20) reason = "è¶…çº§è´´å¿ƒæš–å®å®";
            else if(amount === 50) reason = "ç›´å‡»å¿ƒè„çš„å¿ƒåŠ¨";
        }
        this.addGirlSweetness(amount, reason);
        this.closeSweetModal();
    },

    tryDeductScore() {
        const reason = document.getElementById('reason-input').value.trim();
        if (!reason) return alert('è¯·å¡«å†™æ‰£åˆ†ç†ç”±...ğŸ¥º');
        this.deductStep = 1;
        this.showMercyModal();
    },

    showMercyModal() {
        const texts = this.mercyLevels[this.deductStep];
        const text = texts[Math.floor(Math.random() * texts.length)];
        document.getElementById('mercy-title').innerText = `æ±‚é¥¶ (ç¬¬ ${this.deductStep}/3 æ¬¡)`;
        document.getElementById('mercy-text').innerText = text;
        document.getElementById('mercy-modal').style.display = 'flex';
    },

    forgive() {
        document.getElementById('mercy-modal').style.display = 'none';
        this.deductStep = 0;
        this.showToast('è°¢è°¢è€å©†å¤§äººå¼€æ©ï¼ğŸ˜');
    },

    confirmDeduct() {
        if (this.deductStep < 3) {
            this.deductStep++;
            this.showMercyModal();
        } else {
            const reason = document.getElementById('reason-input').value.trim();
            this.executeChange(-10, reason);
            document.getElementById('mercy-modal').style.display = 'none';
            document.getElementById('reason-input').value = '';
            this.deductStep = 0;
            alert('å‘œå‘œå‘œ...çœŸçš„æ‰£äº†...å¿ƒç¢äº†...ğŸ’”');
        }
    },

    randomTask() {
        document.getElementById('task-text').innerText = this.tasks[Math.floor(Math.random() * this.tasks.length)];
        document.getElementById('task-modal').style.display = 'flex';
    },

    acceptTask() {
        this.executeChange(50, 'å®Œæˆéšæœºç”œèœœä»»åŠ¡');
        this.closeTask();
        this.showToast('ä»»åŠ¡å®Œæˆï¼å¥–åŠ±å·²åˆ°è´¦ï¼ğŸ’ª');
    },

    closeTask() {
        document.getElementById('task-modal').style.display = 'none';
    },

    checkDailySignIn() {
        // common.js å·²å®ç°ç­¾åˆ°æ ¸å¿ƒé€»è¾‘ï¼Œè¿™é‡Œä¸»è¦æ˜¯è§¦å‘å¹¶å¤„ç†UIæ›´æ–°
        // ä½† common.js çš„ checkDailySignIn æ˜¯é€šè¿‡ this è°ƒç”¨ï¼Œè¿™é‡Œéœ€è¦ç¡®ä¿è¦†ç›–æˆ–è€…ä½¿ç”¨ common.js çš„
        // å®é™…ä¸Šï¼Œcommon.js å·²ç»å®šä¹‰äº† checkDailySignInã€‚
        // ä½†ç”±äºæˆ‘ä»¬åœ¨ index.html çš„ script ä¸­ä½¿ç”¨äº† Object.assign è¦†ç›– appï¼Œ
        // å¦‚æœè¿™é‡Œæ²¡æœ‰ checkDailySignInï¼Œå°±ä¼šä½¿ç”¨ common.js çš„ï¼ˆå¦‚æœ common.js æ˜¯å…ˆå®šä¹‰çš„ appï¼Œç„¶å index.html è¿™é‡Œæ‰©å±•ï¼‰
        // è¿™é‡Œçš„ Object.assign æ˜¯æ‰©å±• app å¯¹è±¡ã€‚
        // å¦‚æœ common.js ä¸­çš„ app å¯¹è±¡å·²ç»æœ‰äº† checkDailySignInï¼Œè¿™é‡Œä¸éœ€è¦é‡å†™ï¼Œé™¤ééœ€è¦ç‰¹æ®Šçš„ä¸»é¡µ UI é€»è¾‘ã€‚
        
        // æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ common.js ä¸­çš„é€»è¾‘ï¼Œå¹¶æ·»åŠ  render æ›´æ–°
        const superCheck = app.__proto__?.checkDailySignIn || app.checkDailySignIn; // è·å– common.js çš„å®ç°æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºæ˜¯ç›´æ¥å¯¹è±¡
        
        // å®é™…ä¸Šï¼Œcommon.js é‡Œçš„ app å¯¹è±¡ä¼šè¢«è¿™é‡Œçš„ Object.assign æ‰©å±•ã€‚
        // æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦åœ¨è¿™é‡Œé‡å†™ checkDailySignInï¼Œé™¤éæˆ‘ä»¬è¦ä¿®æ”¹å®ƒçš„è¡Œä¸ºã€‚
        // æˆ‘ä»¬åœ¨ common.js é‡Œå·²ç»é‡å†™äº† checkDailySignIn ä»¥æ”¯æŒåŒäººã€‚
        // è¿™é‡Œåªéœ€è¦ä¿ç•™ showSignInModal å³å¯ï¼ˆå› ä¸ºå®ƒæ¶‰åŠ DOM æ“ä½œï¼Œä¸” DOM åœ¨ index.html ä¸­ï¼‰ã€‚
        
        // è°ƒç”¨ common.js ä¸­å®šä¹‰çš„ checkDailySignIn (å¦‚æœå®ƒå·²ç»åœ¨ app å¯¹è±¡ä¸Š)
        // æ³¨æ„ï¼šObject.assign ä¼šåˆå¹¶å±æ€§ã€‚æˆ‘ä»¬åœ¨ common.js å®šä¹‰äº† appï¼Œè¿™é‡Œåˆå®šä¹‰äº†ä¸€å †æ–¹æ³•åˆå¹¶è¿›å»ã€‚
        // æ‰€ä»¥è¿™é‡Œ**ä¸éœ€è¦**å†å®šä¹‰ checkDailySignInï¼Œç›´æ¥è®©å®ƒæ‰§è¡Œ common.js çš„å³å¯ã€‚
        // å”¯ä¸€çš„é—®é¢˜æ˜¯ showSignInModal éœ€è¦æ“ä½œ index.html ç‰¹æœ‰çš„ DOMã€‚
        // æ‰€ä»¥æˆ‘ä»¬åœ¨ common.js ç•™äº† showSignInModal çš„ç©ºå®ç°æˆ–è€…åŸºç¡€å®ç°ï¼Ÿ
        // common.js é‡Œæ²¡æœ‰ showSignInModal çš„å…·ä½“å®ç°ï¼ˆå› ä¸ºæ¶‰åŠå¼¹çª— DOMï¼‰ã€‚
        // æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œå®ç° showSignInModalã€‚
        
        // è§¦å‘ç­¾åˆ°æ£€æŸ¥ (ç”± common.js çš„ initCommon è°ƒç”¨ï¼Œæˆ–è€…è¿™é‡Œæ‰‹åŠ¨è°ƒç”¨)
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        
        const lastSignInField = this.currentUser === 'boy' ? 'lastSignInDate_Boy' : 'lastSignInDate_Girl';
        
        // åªæœ‰å½“ä»Šå¤©æ²¡ç­¾åˆ°æ—¶æ‰æ‰§è¡Œæ ¸å¿ƒé€»è¾‘
        if (this.data[lastSignInField] !== todayStr) {
             // è¿™é‡Œçš„é€»è¾‘ç¨å¾®æœ‰ç‚¹ç»•ï¼Œä¸ºäº†ç®€å•ï¼Œæˆ‘ç›´æ¥åœ¨è¿™é‡Œé‡å†™ checkDailySignIn ä»¥ç¡®ä¿é€»è¾‘æ­£ç¡®
             // å¹¶ä¸”è°ƒç”¨ common.js çš„ executeChange
             
            let diffDays = 0;
            if (this.data.lastSignInDate) {
                const last = new Date(this.data.lastSignInDate);
                const utc1 = Date.UTC(last.getFullYear(), last.getMonth(), last.getDate());
                const utc2 = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
                diffDays = Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));
            }

            if (diffDays > 1 || !this.data.lastSignInDate) {
                this.data.signInStreak = 1;
            } else if (diffDays === 1) {
                if (this.data.lastSignInDate !== todayStr) {
                    this.data.signInStreak++;
                }
            }

            let reward = 1;
            let title = this.getTimeGreeting();
            let subText = "æ¯æ—¥ç­¾åˆ°å¥–åŠ±";
            let icon = this.getTimeIcon();
            let extraReward = false;

            const partnerField = this.currentUser === 'boy' ? 'lastSignInDate_Girl' : 'lastSignInDate_Boy';
            const partnerSignIn = this.data[partnerField] === todayStr;

            if (partnerSignIn) {
                reward = 5;
                title = "â¤ï¸ å¿ƒæœ‰çµçŠ€ï¼";
                subText = "å¦ä¸€åŠä¹Ÿç­¾åˆ°äº†ï¼è§¦å‘åŒå€ç”œèœœæš´å‡»ï¼";
                icon = "ğŸ‘©â€â¤ï¸â€ğŸ‘¨";
            } else if (this.data.signInStreak % 7 === 0 && this.data.lastSignInDate !== todayStr) {
                reward = 20; 
                title = "ğŸ‰ è¿å‡»å¤§ç¤¼åŒ…ï¼";
                subText = `å¤ªæ£’äº†ï¼å·²è¿ç»­æ‰“å¡ ${this.data.signInStreak} å¤©ï¼`;
                icon = "ğŸ";
                extraReward = true;
            }

            this.data[lastSignInField] = todayStr;
            this.data.lastSignInDate = todayStr;
            
            this.data.signInLog.unshift({
                date: todayStr,
                user: this.currentUser,
                time: new Date().toLocaleTimeString()
            });
            
            this.executeChange(reward, `æ¯æ—¥ç­¾åˆ° (${this.currentUser === 'boy' ? 'ç”·æœ‹å‹' : 'å‘¨é‡‘éœ'}) ${partnerSignIn ? '+ åŒäººåŠ æˆ' : ''}`);
            this.showSignInModal(false, title, subText, icon, reward, extraReward);
        } else {
            // å·²ç­¾åˆ°ï¼Œåªæ›´æ–°UI
            this.updateStreakUI();
            this.renderSignInStatus();
        }
    },

    showSignInModal(isViewOnly = false, title, subText, icon, reward, isBigReward) {
        const modal = document.getElementById('signin-modal');
        const streak = this.data.signInStreak;
        
        if (isViewOnly) {
            document.getElementById('signin-title').innerText = `å·²è¿ç»­æ‰“å¡ ${streak} å¤©`;
            document.getElementById('signin-text').innerText = "åšæŒå°±æ˜¯èƒœåˆ©ï¼ŒåŠ æ²¹ï¼ğŸ’ª";
            document.getElementById('signin-icon').innerText = "ğŸ”¥";
            document.getElementById('signin-reward-text').style.display = 'none';
        } else {
            document.getElementById('signin-title').innerText = title;
            document.getElementById('signin-text').innerText = subText;
            document.getElementById('signin-icon').innerText = icon;
            const rewardEl = document.getElementById('signin-reward-text');
            rewardEl.style.display = 'flex';
            rewardEl.innerHTML = isBigReward 
                ? `<span>ğŸ</span> è¿å‡»å¥–åŠ± +${reward} åˆ†` 
                : `<span>ğŸ’</span> ç§¯åˆ† +${reward}`;
        }

        const dotsContainer = document.getElementById('streak-dots');
        let dotsHtml = '';
        let currentCycle = streak % 7; 
        if (currentCycle === 0 && streak > 0) currentCycle = 7;
        
        for (let i = 1; i <= 7; i++) {
            const isActive = i <= currentCycle;
            dotsHtml += `<div class="streak-dot ${isActive ? 'active' : ''}"></div>`;
        }
        dotsContainer.innerHTML = dotsHtml;
        document.getElementById('signin-streak').innerText = streak;

        modal.style.display = 'flex';
        this.updateStreakUI();
        this.renderSignInStatus(); // ç­¾åˆ°åæ›´æ–°çŠ¶æ€æ 
    },

    closeSignIn() {
        document.getElementById('signin-modal').style.display = 'none';
        createPetal(); createPetal(); createPetal();
    },

    updateStreakUI() {
        const el = document.getElementById('home-streak');
        if(el) {
            const numEl = document.getElementById('streak-num');
            if (numEl) numEl.innerText = this.data.signInStreak;
        }
    },

    getTimeGreeting() {
        const hour = new Date().getHours();
        if (hour < 6) return "å‡Œæ™¨å¥½ï¼ğŸŒ™";
        if (hour < 9) return "æ—©å®‰ï¼â˜€ï¸";
        if (hour < 12) return "ä¸Šåˆå¥½ï¼â˜•";
        if (hour < 14) return "åˆå®‰ï¼ğŸ±";
        if (hour < 18) return "ä¸‹åˆå¥½ï¼ğŸµ";
        if (hour < 22) return "æ™šä¸Šå¥½ï¼âœ¨";
        return "æ™šå®‰ï¼ğŸ’¤";
    },

    getTimeIcon() {
        const hour = new Date().getHours();
        if (hour < 6) return "ğŸŒŒ";
        if (hour < 18) return "â˜€ï¸";
        return "ğŸŒ™";
    },

    renderPeriod() {
        const display = document.getElementById('period-display');
        if (!display) return;
        
        if (!this.data.periodDate) {
            return;
        }

        const lastDate = new Date(this.data.periodDate);
        const today = new Date();
        const cycle = 28;
        
        const nextDate = new Date(lastDate);
        nextDate.setDate(lastDate.getDate() + cycle);
        
        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        
        let msg = '';
        let color = '';

        if (daysUntil > 0) {
            msg = `è·ç¦»ä¸‹æ¬¡è¿˜å‰© <span class="period-days">${daysUntil}</span> å¤©`;
            color = '#fff';
        } else if (daysUntil === 0) {
            msg = `å°±æ˜¯ä»Šå¤©ï¼<br>è®°å¾—å¤šå–çƒ­æ°´ï¼Œæ³¨æ„ä¿æš–å“¦ â¤ï¸`;
            color = '#ffcccb';
        } else {
            msg = `å·²ç»æ¨è¿Ÿ <span class="period-days">${Math.abs(daysUntil)}</span> å¤©äº†<br>æˆ–è€…æ˜¯å¿˜è®°è®°å½•å•¦ï¼ŸğŸ¤”`;
            color = '#ffd1dc';
        }

        display.innerHTML = `
            <div class="period-info">ä¸Šæ¬¡è®°å½•ï¼š${this.data.periodDate}</div>
            <div style="margin-top:5px; color:${color}">${msg}</div>
        `;
    }
});

app.init();
</script>
</body>
</html>
