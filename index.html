<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å‘¨é‡‘éœç”·å‹">
    <title>å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ V3.1 äº‘åŒæ­¥ç‰ˆ â¤ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        /* ä¸»é¡µç‰¹å®šæ ·å¼ */
        .btn-del-photo {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>
<!-- èƒŒæ™¯è£…é¥° -->
<div class="bg-shape shape-1"></div>
<div class="bg-shape shape-2"></div>
<div id="sakura-container"></div>

<div class="container">
    <header>
        <h1>å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ <span class="version-tag">V3.1</span></h1>
        <div class="love-days">å·²ç»è®¤è¯† <span id="days-count">0</span> å¤©å•¦ ğŸ’•</div>
    </header>
    
    <div id="daily-quote" class="daily-quote">åŠ è½½ä¸­...</div>

    <!-- å¯¼èˆªæ  -->
    <div class="nav-tabs">
        <a href="index.html" class="nav-btn active">ğŸ  ä¸»é¡µ</a>
        <a href="wishlist.html" class="nav-btn">âœ¨ æ„¿æœ›</a>
        <a href="album.html" class="nav-btn">ğŸ–¼ï¸ ç›¸å†Œ</a>
		<a href="settings.html" class="nav-btn">âš™ï¸ è®¾ç½®</a>
        <a href="shop.html" class="nav-btn">ğŸ å•†åº—</a>
       
    </div>

    <!-- ä¸»é¡µå†…å®¹ -->
    <div class="score-card">
        <div class="home-streak-badge" id="home-streak" onclick="app.showSignInModal(true)">
            <span>ğŸ”¥</span> <span id="streak-num">0</span> å¤©
        </div>
        <div class="score-content">
            <div class="score-title">Current Score</div>
            <div class="score-value" id="score-display">0</div>
            <div class="rank-badge" id="rank-display">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- ç”Ÿç†æœŸå¡ç‰‡ -->
    <div class="period-card" onclick="location.href='settings.html'">
        <h3>ğŸ©¸ å§¨å¦ˆåŠ©æ‰‹</h3>
        <div id="period-display">
            <div class="period-info">ä¸Šæ¬¡è®°å½•ï¼šæš‚æ— æ•°æ®</div>
            <div class="period-info">è¯·å»è®¾ç½®é¡µè®°å½•æ—¥æœŸå“¦ ~</div>
        </div>
    </div>

    <input type="text" id="reason-input" placeholder="âœ¨ è®°å½•æ¯ä¸€ä¸ªå¿ƒåŠ¨ç¬é—´...">

    <div class="action-buttons">
        <button class="btn btn-add" onclick="app.addScore()">
            <span>ğŸ’–</span> ç”œèœœåŠ åˆ†
        </button>
        <button class="btn btn-sub" onclick="app.tryDeductScore()">
            <span>ğŸ’”</span> æ®‹å¿å‡åˆ†
        </button>
    </div>

    <button class="btn btn-random" onclick="app.randomTask()">ğŸ² éšæœºä»»åŠ¡ (èµšå–ç§¯åˆ†)</button>
</div>

<!-- æ±‚é¥¶å¼¹çª— -->
<div class="modal-overlay" id="mercy-modal" style="display:none;">
    <div class="modal">
        <span style="font-size:3rem; display:block; margin-bottom:15px; animation: bounce 1s infinite;">ğŸ¥º</span>
        <h3 id="mercy-title" style="margin:0 0 10px 0; color:var(--text-main);">æ‰‹ä¸‹ç•™æƒ…é¸­ï¼</h3>
        <p id="mercy-text" style="color:#666; margin-bottom:20px; line-height:1.5;">å®å®æˆ‘é”™äº†...</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="app.forgive()" style="background:linear-gradient(135deg, #a8edea, #fed6e3); color:#5e4b56; border:none; padding:12px; border-radius:12px; font-weight:bold;">ğŸ’– åŸè°…ä»– (ä¸æ‰£åˆ†)</button>
            <button onclick="app.confirmDeduct()" style="background:transparent; border:1px solid #ff9a9e; color:#ff9a9e; padding:10px; border-radius:12px;">ğŸ’” å¿…é¡»æ‰£ (æ®‹å¿)</button>
        </div>
    </div>
</div>

<!-- ç­¾åˆ°å¼¹çª— -->
<div class="modal-overlay" id="signin-modal" style="display:none;">
    <div class="modal" style="width:85%; max-width:340px; padding:30px 20px;">
        <div class="signin-header">
            <span class="signin-icon" id="signin-icon">â˜€ï¸</span>
            <h2 class="signin-title" id="signin-title">æ—©å®‰ï¼</h2>
            <div class="signin-subtitle" id="signin-text">æ–°çš„ä¸€å¤©ä¹Ÿè¦å¼€å¿ƒå“¦~</div>
        </div>
        <div class="streak-container">
            <div class="streak-label">Current Streak</div>
            <div class="streak-count"><span id="signin-streak">1</span> DAYS</div>
            <div class="streak-dots" id="streak-dots"></div>
        </div>
        <div class="signin-reward" id="signin-reward-text">
            <span>ğŸ’</span> ç§¯åˆ† +1
        </div>
        <button class="btn-signin" onclick="app.closeSignIn()">å¼€å¯ç¾å¥½ä¸€å¤© âœ¨</button>
    </div>
</div>

<!-- éšæœºä»»åŠ¡å¼¹çª— -->
<div class="modal-overlay" id="task-modal" style="display:none;">
    <div class="modal">
        <span style="font-size:3rem; display:block; margin-bottom:15px;">ğŸ</span>
        <h3 style="margin:0 0 10px 0;">éšæœºç”œèœœä»»åŠ¡</h3>
        <p id="task-text" style="color:#666; margin-bottom:20px;">ä»»åŠ¡åŠ è½½ä¸­...</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="app.acceptTask()" style="background:var(--accent-blue); color:white; border:none; padding:12px; border-radius:12px;">ğŸ’ª æ¥ä¸‹ä»»åŠ¡ (+50åˆ†)</button>
            <button onclick="app.closeTask()" style="background:transparent; color:#999; border:none; padding:10px;">ä¸‹æ¬¡ä¸€å®š</button>
        </div>
    </div>
</div>

<!-- iOS å®‰è£…æç¤º -->
<div id="ios-install-guide">
    ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„ <span class="ios-guide-icon">åˆ†äº«</span> æŒ‰é’®<br>
    ç„¶åé€‰æ‹© <strong>"æ·»åŠ åˆ°ä¸»å±å¹•"</strong> å³å¯ç”Ÿæˆå›¾æ ‡ â¤ï¸
    <div style="margin-top:10px; font-size:0.8rem; color:#999; cursor:pointer;" onclick="this.parentElement.style.display='none'">[æˆ‘çŸ¥é“äº†]</div>
</div>

<script src="common.js"></script>
<script>
// ä¸»é¡µç‰¹å®šåŠŸèƒ½
Object.assign(app, {
    init() {
        this.initCommon();
        // å»¶è¿Ÿæ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½ï¼ˆinitCommonä¸­å·²å°è¯•åŠ è½½æœ¬åœ°æ•°æ®ï¼‰
        setTimeout(() => {
            this.render();
            this.checkDailySignIn();
        }, 100);
    },

    render() {
        const scoreEl = document.getElementById('score-display');
        const rankEl = document.getElementById('rank-display');
        if (scoreEl) scoreEl.innerText = this.data.score;
        if (rankEl) rankEl.innerText = this.getRank();
        
        const body = document.body;
        const scoreCard = document.querySelector('.score-card');
        const scoreTitle = document.querySelector('.score-title');

        if (scoreCard && scoreTitle) {
            if (this.data.score < 0) {
                scoreCard.style.background = 'linear-gradient(135deg, #e63946, #000000)';
                scoreTitle.innerText = "âš ï¸ çº¢è‰²è­¦æŠ¥ âš ï¸";
                let grayLevel = Math.min(1, Math.abs(this.data.score) / 500); 
                let brightnessLevel = Math.max(0.4, 1 - (Math.abs(this.data.score) / 800));
                body.style.filter = `grayscale(${grayLevel}) brightness(${brightnessLevel})`;
            } else {
                scoreCard.style.background = 'linear-gradient(135deg, rgba(255, 154, 158, 0.9), rgba(254, 207, 239, 0.9))';
                scoreTitle.innerText = "Current Score";
                body.style.filter = 'none';
            }
        }

        this.renderPeriod();
        this.updateStreakUI();
    },

    addScore() {
        const reason = document.getElementById('reason-input').value.trim();
        if (!reason) return alert('è¯·å¡«å†™ç”œèœœç†ç”±å“¦ï¼âœ¨');
        this.executeChange(10, reason);
        document.getElementById('reason-input').value = '';
        this.showToast('åŠ åˆ†æˆåŠŸï¼çˆ±ä½ å“Ÿï¼ğŸ˜˜');
    },

    tryDeductScore() {
        const reason = document.getElementById('reason-input').value.trim();
        if (!reason) return alert('è¯·å¡«å†™æ‰£åˆ†ç†ç”±...ğŸ¥º');
        this.deductStep = 1;
        this.showMercyModal();
    },

    showMercyModal() {
        const texts = this.mercyLevels[this.deductStep];
        const text = texts[Math.floor(Math.random() * texts.length)];
        document.getElementById('mercy-title').innerText = `æ±‚é¥¶ (ç¬¬ ${this.deductStep}/3 æ¬¡)`;
        document.getElementById('mercy-text').innerText = text;
        document.getElementById('mercy-modal').style.display = 'flex';
    },

    forgive() {
        document.getElementById('mercy-modal').style.display = 'none';
        this.deductStep = 0;
        this.showToast('è°¢è°¢è€å©†å¤§äººå¼€æ©ï¼ğŸ˜');
    },

    confirmDeduct() {
        if (this.deductStep < 3) {
            this.deductStep++;
            this.showMercyModal();
        } else {
            const reason = document.getElementById('reason-input').value.trim();
            this.executeChange(-10, reason);
            document.getElementById('mercy-modal').style.display = 'none';
            document.getElementById('reason-input').value = '';
            this.deductStep = 0;
            alert('å‘œå‘œå‘œ...çœŸçš„æ‰£äº†...å¿ƒç¢äº†...ğŸ’”');
        }
    },

    randomTask() {
        document.getElementById('task-text').innerText = this.tasks[Math.floor(Math.random() * this.tasks.length)];
        document.getElementById('task-modal').style.display = 'flex';
    },

    acceptTask() {
        this.executeChange(50, 'å®Œæˆéšæœºç”œèœœä»»åŠ¡');
        this.closeTask();
        this.showToast('ä»»åŠ¡å®Œæˆï¼å¥–åŠ±å·²åˆ°è´¦ï¼ğŸ’ª');
    },

    closeTask() {
        document.getElementById('task-modal').style.display = 'none';
    },

    checkDailySignIn() {
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        
        if (this.data.lastSignInDate === todayStr) {
            this.updateStreakUI();
            return;
        }

        let diffDays = 0;
        if (this.data.lastSignInDate) {
            const last = new Date(this.data.lastSignInDate);
            const utc1 = Date.UTC(last.getFullYear(), last.getMonth(), last.getDate());
            const utc2 = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
            diffDays = Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));
        }

        if (diffDays === 1) {
            this.data.signInStreak++;
        } else if (diffDays > 1 || !this.data.lastSignInDate) {
            this.data.signInStreak = 1;
        }

        let reward = 1;
        let title = this.getTimeGreeting();
        let subText = "æ¯æ—¥ç­¾åˆ°å¥–åŠ±";
        let icon = this.getTimeIcon();
        let extraReward = false;

        if (this.data.signInStreak % 7 === 0) {
            reward = 20;
            title = "ğŸ‰ è¿å‡»å¤§ç¤¼åŒ…ï¼";
            subText = `å¤ªæ£’äº†ï¼å·²è¿ç»­æ‰“å¡ ${this.data.signInStreak} å¤©ï¼`;
            icon = "ğŸ";
            extraReward = true;
        }

        this.data.lastSignInDate = todayStr;
        this.executeChange(reward, `æ¯æ—¥ç­¾åˆ° (è¿å‡» ${this.data.signInStreak} å¤©)`);

        this.showSignInModal(false, title, subText, icon, reward, extraReward);
    },

    showSignInModal(isViewOnly = false, title, subText, icon, reward, isBigReward) {
        const modal = document.getElementById('signin-modal');
        const streak = this.data.signInStreak;
        
        if (isViewOnly) {
            document.getElementById('signin-title').innerText = `å·²è¿ç»­æ‰“å¡ ${streak} å¤©`;
            document.getElementById('signin-text').innerText = "åšæŒå°±æ˜¯èƒœåˆ©ï¼ŒåŠ æ²¹ï¼ğŸ’ª";
            document.getElementById('signin-icon').innerText = "ğŸ”¥";
            document.getElementById('signin-reward-text').style.display = 'none';
        } else {
            document.getElementById('signin-title').innerText = title;
            document.getElementById('signin-text').innerText = subText;
            document.getElementById('signin-icon').innerText = icon;
            const rewardEl = document.getElementById('signin-reward-text');
            rewardEl.style.display = 'flex';
            rewardEl.innerHTML = isBigReward 
                ? `<span>ğŸ</span> è¿å‡»å¥–åŠ± +${reward} åˆ†` 
                : `<span>ğŸ’</span> ç§¯åˆ† +${reward}`;
        }

        const dotsContainer = document.getElementById('streak-dots');
        let dotsHtml = '';
        let currentCycle = streak % 7; 
        if (currentCycle === 0 && streak > 0) currentCycle = 7;
        
        for (let i = 1; i <= 7; i++) {
            const isActive = i <= currentCycle;
            dotsHtml += `<div class="streak-dot ${isActive ? 'active' : ''}"></div>`;
        }
        dotsContainer.innerHTML = dotsHtml;
        document.getElementById('signin-streak').innerText = streak;

        modal.style.display = 'flex';
        this.updateStreakUI();
    },

    closeSignIn() {
        document.getElementById('signin-modal').style.display = 'none';
        createPetal(); createPetal(); createPetal();
    },

    updateStreakUI() {
        const el = document.getElementById('home-streak');
        if(el) {
            const numEl = document.getElementById('streak-num');
            if (numEl) numEl.innerText = this.data.signInStreak;
        }
    },

    getTimeGreeting() {
        const hour = new Date().getHours();
        if (hour < 6) return "å‡Œæ™¨å¥½ï¼ğŸŒ™";
        if (hour < 9) return "æ—©å®‰ï¼â˜€ï¸";
        if (hour < 12) return "ä¸Šåˆå¥½ï¼â˜•";
        if (hour < 14) return "åˆå®‰ï¼ğŸ±";
        if (hour < 18) return "ä¸‹åˆå¥½ï¼ğŸµ";
        if (hour < 22) return "æ™šä¸Šå¥½ï¼âœ¨";
        return "æ™šå®‰ï¼ğŸ’¤";
    },

    getTimeIcon() {
        const hour = new Date().getHours();
        if (hour < 6) return "ğŸŒŒ";
        if (hour < 18) return "â˜€ï¸";
        return "ğŸŒ™";
    },

    renderPeriod() {
        const display = document.getElementById('period-display');
        if (!display) return;
        
        if (!this.data.periodDate) {
            return;
        }

        const lastDate = new Date(this.data.periodDate);
        const today = new Date();
        const cycle = 28;
        
        const nextDate = new Date(lastDate);
        nextDate.setDate(lastDate.getDate() + cycle);
        
        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        
        let msg = '';
        let color = '';

        if (daysUntil > 0) {
            msg = `è·ç¦»ä¸‹æ¬¡è¿˜å‰© <span class="period-days">${daysUntil}</span> å¤©`;
            color = '#fff';
        } else if (daysUntil === 0) {
            msg = `å°±æ˜¯ä»Šå¤©ï¼<br>è®°å¾—å¤šå–çƒ­æ°´ï¼Œæ³¨æ„ä¿æš–å“¦ â¤ï¸`;
            color = '#ffcccb';
        } else {
            msg = `å·²ç»æ¨è¿Ÿ <span class="period-days">${Math.abs(daysUntil)}</span> å¤©äº†<br>æˆ–è€…æ˜¯å¿˜è®°è®°å½•å•¦ï¼ŸğŸ¤”`;
            color = '#ffd1dc';
        }

        display.innerHTML = `
            <div class="period-info">ä¸Šæ¬¡è®°å½•ï¼š${this.data.periodDate}</div>
            <div style="margin-top:5px; color:${color}">${msg}</div>
        `;
    }
});

app.init();
</script>
</body>
</html>
