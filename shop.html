<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å‘¨é‡‘éœç”·å‹">
    <title>æ‹çˆ±å•†åº— - å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ â¤ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link rel="stylesheet" href="common.css">
</head>
<body>
<div class="bg-shape shape-1"></div>
<div class="bg-shape shape-2"></div>
<div id="sakura-container"></div>

<div class="container">
    <header>
        <h1>ğŸ æ‹çˆ±å•†åº— <span class="version-tag">V3.3</span></h1>
        <div class="love-days">å·²ç»è®¤è¯† <span id="days-count">0</span> å¤©å•¦ ğŸ’•</div>
    </header>

    <div class="nav-tabs">
        <a href="index.html" class="nav-btn">ğŸ  ä¸»é¡µ</a>
        <a href="wishlist.html" class="nav-btn">âœ¨ æ„¿æœ›</a>
        <a href="album.html" class="nav-btn">ğŸ–¼ï¸ ç›¸å†Œ</a>
        <a href="settings.html" class="nav-btn">âš™ï¸ è®¾ç½®</a>
		<a href="shop.html" class="nav-btn active">ğŸ å•†åº—</a>
    </div>

    <div class="shop-tabs">
        <button class="shop-tab-btn active" onclick="app.switchShopTab('mall')" id="tab-mall">ğŸ ç”·å‹å…‘æ¢</button>
        <button class="shop-tab-btn" onclick="app.switchShopTab('girl-mall')" id="tab-girl-mall">ğŸ‘‘ å¥³ç‹æƒç›Š</button>
        <button class="shop-tab-btn" onclick="app.switchShopTab('inventory')" id="tab-inventory">ğŸ’ æˆ‘çš„èƒŒåŒ…</button>
    </div>

    <div id="view-mall">
        <div class="shop-grid" id="shop-list"></div>
    </div>
    
    <div id="view-girl-mall" style="display: none;">
        <div class="shop-grid" id="girl-shop-list"></div>
    </div>

    <div id="view-inventory" style="display: none;">
        <div class="inventory-list" id="inventory-list"></div>
    </div>
</div>

<!-- ä½¿ç”¨ç‰©å“å¼¹çª— -->
<div class="modal-overlay" id="use-modal" style="display:none;">
    <div class="modal">
        <span id="use-icon" style="font-size:3rem; display:block; margin-bottom:15px;">ğŸ«</span>
        <h3 style="margin:0 0 10px 0;">ä½¿ç”¨ç‰©å“</h3>
        <p id="use-modal-text" style="color:#666; margin-bottom:20px; line-height:1.5;">ç¡®å®šè¦ä½¿ç”¨ <span id="use-name" style="font-weight:bold; color:var(--accent-pink);"></span> å—ï¼Ÿ<br><span style="font-size:0.8rem;">(ä½¿ç”¨åå°†å˜ä¸ºå·²æ ¸é”€çŠ¶æ€)</span></p>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('use-modal').style.display='none'" style="flex:1; background:#f0f0f0; border:none; padding:12px; border-radius:12px;">å–æ¶ˆ</button>
            <button onclick="app.confirmUse()" style="flex:1; background:linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:12px; border-radius:12px; font-weight:bold;">ç¡®è®¤ä½¿ç”¨</button>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
Object.assign(app, {
    init() {
        this.initCommon();
        this.render();
    },

    render() {
        // æ¸²æŸ“ç”·å‹å…‘æ¢åŒº (åªæ˜¾ç¤º owner ä¸º boy æˆ– undefined çš„)
        const shopList = document.getElementById('shop-list');
        if (shopList) {
            shopList.innerHTML = this.products.filter(p => !p.owner || p.owner === 'boy').map(p => `
                <div class="shop-item">
                    <div class="shop-icon">${p.icon}</div>
                    <div style="font-weight:bold; margin-bottom:5px;">${p.name}</div>
                    <div class="shop-price">${p.price} åˆ†</div>
                    <button class="btn-buy" ${this.data.score >= p.price ? '' : 'disabled'} onclick="app.buyProduct(${p.id})">
                        ${this.data.score >= p.price ? 'å…‘æ¢' : 'ç§¯åˆ†ä¸è¶³'}
                    </button>
                </div>
            `).join('');
        }
        
        // æ¸²æŸ“å¥³ç‹æƒç›ŠåŒº (åªæ˜¾ç¤º owner ä¸º girl çš„)
        const girlShopList = document.getElementById('girl-shop-list');
        if (girlShopList) {
            const sweetVal = this.data.girlSweetness || 0;
            girlShopList.innerHTML = this.products.filter(p => p.owner === 'girl').map(p => `
                <div class="shop-item" style="border-color: #ff9a9e; background: rgba(255,255,255,0.7);">
                    <div class="shop-icon">${p.icon}</div>
                    <div style="font-weight:bold; margin-bottom:5px; color:#d6336c;">${p.name}</div>
                    <div style="font-size:0.75rem; color:#888; margin-bottom:5px;">${p.desc}</div>
                    <div class="shop-price" style="color: #ff9a9e;">${p.price} ğŸ¬</div>
                    <button class="btn-buy" 
                        style="${sweetVal >= p.price ? 'background: linear-gradient(135deg, #ff9a9e, #fecfef);' : 'background:#ddd;'}"
                        ${sweetVal >= p.price ? '' : 'disabled'} 
                        onclick="app.buyProduct(${p.id})">
                        ${sweetVal >= p.price ? 'å…‘æ¢æƒç›Š' : 'ç”œåº¦ä¸è¶³'}
                    </button>
                </div>
            `).join('');
        }

        // æ¸²æŸ“èƒŒåŒ…
        const invList = document.getElementById('inventory-list');
        if (!invList) return;
        
        if (!this.data.inventory || this.data.inventory.length === 0) {
            invList.innerHTML = '<div class="empty-hint">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ<br>å¿«å»å•†åº—å…‘æ¢å¥–åŠ±å§ï¼ğŸ</div>';
        } else {
            invList.innerHTML = this.data.inventory.map(item => {
                const isUsed = item.status === 'used';
                const isGirlItem = item.owner === 'girl'; // åˆ¤æ–­æ˜¯å¦æ˜¯å¥³ç‹æƒç›Š
                
                // åŠ¨æ€æ ·å¼ï¼šå¥³ç‹æƒç›Šæ˜¾ç¤ºç²‰è‰²èƒŒæ™¯/è¾¹æ¡†ï¼Œç”·å‹æƒç›Šä¿æŒé»˜è®¤
                const itemStyle = isGirlItem 
                    ? 'border: 2px solid #ff9a9e; background: rgba(255, 235, 238, 0.9);' 
                    : '';
                
                const nameStyle = isGirlItem ? 'color: #d6336c;' : '';
                
                return `
                    <div class="inventory-item ${isUsed ? 'used' : 'unused'}" 
                         style="${itemStyle}"
                         onclick="${isUsed ? '' : `app.askUseItem(${item.id})`}">
                        <div class="inv-icon">${item.icon}</div>
                        <div class="inv-info">
                            <div class="inv-name" style="${nameStyle}">
                                ${isGirlItem ? 'ğŸ‘‘ ' : ''}${item.name}
                            </div>
                            <div class="inv-date">${isUsed ? 'ä½¿ç”¨äº: ' + item.useTime : 'å…‘æ¢äº: ' + item.buyTime}</div>
                        </div>
                        ${isUsed ? '<div class="stamp-used"></div>' : 
                          `<button class="btn-use" style="${isGirlItem ? 'background: linear-gradient(135deg, #ff9a9e, #fecfef);' : ''}">
                             ${isGirlItem ? 'ä½¿ç”¨' : 'ä½¿ç”¨'}
                           </button>`}
                    </div>
                `;
            }).join('');
        }
    },

    switchShopTab(tab) {
        document.querySelectorAll('.shop-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        document.getElementById('view-mall').style.display = tab === 'mall' ? 'block' : 'none';
        document.getElementById('view-girl-mall').style.display = tab === 'girl-mall' ? 'block' : 'none';
        document.getElementById('view-inventory').style.display = tab === 'inventory' ? 'block' : 'none';
    },

    buyProduct(id) {
        const p = this.products.find(x => x.id === id);
        if (!p) return;
        
        // åŒºåˆ†è´­ä¹°é€»è¾‘
        if (p.owner === 'girl') {
            // å¥³ç‹æƒç›Šè´­ä¹°é€»è¾‘
            const sweetVal = this.data.girlSweetness || 0;
            if (sweetVal < p.price) {
                return this.showToast('ç”œåº¦ä¸è¶³å“¦ï¼Œå¿«å»è®©ä»–å¤¸å¤¸ä½ ï¼ğŸ’•');
            }
            if (confirm(`ç¡®è®¤å…‘æ¢ã€${p.name}ã€‘å—ï¼Ÿ\n(æ¶ˆè€— ${p.price} ç”œåº¦)`)) {
                this.data.girlSweetness -= p.price;
                this.addInventoryItem(p, 'used'); // æƒç›Šç±»å•†å“ç›´æ¥æ ¸é”€æˆ–æ”¾å…¥èƒŒåŒ…ï¼Ÿå»ºè®®æ”¾å…¥èƒŒåŒ…
                this.saveData();
                this.showToast('å…‘æ¢æˆåŠŸï¼å¿«å»æ‰¾ä»–å…‘ç°å§ï¼ğŸ‘‘');
            }
        } else {
            // åŸæœ‰ç”·å‹è´­ä¹°é€»è¾‘
            if (this.data.score < p.price) {
                return this.showToast('ç§¯åˆ†ä¸è¶³å“¦ï¼Œå¿«å»èµšç§¯åˆ†å§ï¼ğŸ¥º');
            }
            if (confirm(`ç¡®è®¤å…‘æ¢ ${p.name} å—ï¼Ÿ\n(æ¶ˆè€— ${p.price} ç§¯åˆ†ï¼Œç‰©å“å°†æ”¾å…¥èƒŒåŒ…)`)) {
                this.executeChange(-p.price, `è´­ä¹°å•†å“ï¼š${p.name}`);
                this.addInventoryItem(p);
                this.saveData();
                this.showToast('å…‘æ¢æˆåŠŸï¼å·²æ”¾å…¥èƒŒåŒ… ğŸ’');
            }
        }
    },
    
    addInventoryItem(p, status = 'unused') {
        if (!this.data.inventory) this.data.inventory = [];
        this.data.inventory.unshift({
            id: Date.now(),
            productId: p.id,
            name: p.name,
            icon: p.icon,
            price: p.price,
            owner: p.owner || 'boy', // è®°å½•ç‰©å“å½’å±
            buyTime: new Date().toLocaleString(),
            status: status
        });
    },

    askUseItem(itemId) {
        const item = this.data.inventory.find(i => i.id === itemId);
        if (!item || item.status === 'used') return;
        
        this.pendingUseItem = itemId;
        document.getElementById('use-icon').innerText = item.icon;
        document.getElementById('use-name').innerText = item.name;
        
        // é’ˆå¯¹å¥³ç‹æƒç›Šæ˜¾ç¤ºä¸åŒçš„æç¤ºè¯­
        const modalText = document.getElementById('use-modal-text');
        if (item.owner === 'girl') {
            modalText.innerHTML = `ç¡®å®šè¦è¡Œä½¿ <span style="font-weight:bold; color:#d6336c;">${item.name}</span> æƒç›Šå—ï¼Ÿ<br><span style="font-size:0.8rem; color:#888;">(ç‚¹å‡»ç¡®è®¤åï¼Œè¯·æŠŠæ‰‹æœºå±•ç¤ºç»™åˆ˜æ™ºå‹‡çœ‹ï¼Œè®©ä»–ç«‹åˆ»æ‰§è¡Œï¼ğŸ˜¤)</span>`;
        } else {
            modalText.innerHTML = `ç¡®å®šè¦ä½¿ç”¨ <span style="font-weight:bold; color:var(--accent-pink);">${item.name}</span> å—ï¼Ÿ<br><span style="font-size:0.8rem; color:#888;">(ä½¿ç”¨åå°†å˜ä¸ºå·²æ ¸é”€çŠ¶æ€)</span>`;
        }
        
        document.getElementById('use-modal').style.display = 'flex';
    },

    confirmUse() {
        if (!this.pendingUseItem) return;
        
        const item = this.data.inventory.find(i => i.id === this.pendingUseItem);
        if (item) {
            item.status = 'used';
            item.useTime = new Date().toLocaleString();
            this.saveData();
            this.showToast('ä½¿ç”¨æˆåŠŸï¼è¦å¼€å¿ƒå“¦ â¤ï¸');
        }
        
        document.getElementById('use-modal').style.display = 'none';
        this.pendingUseItem = null;
    }
});

app.init();
</script>
</body>
</html>

