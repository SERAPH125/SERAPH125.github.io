<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å‘¨é‡‘éœç”·å‹">
    <title>å¹´åº¦è®¡åˆ’ - å°å‘¨çš„ç”·å‹å…»æˆè®¡åˆ’ â¤ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        /* å¹´åº¦è®¡åˆ’ç‰¹å®šæ ·å¼ - æŠ˜å é¢æ¿é£æ ¼ */
        .plan-category-group {
            background: rgba(255,255,255,0.4);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .plan-category-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            user-select: none;
            border-left: 5px solid var(--accent-pink);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        /* è¿›åº¦æ¡èƒŒæ™¯å±‚ */
        .plan-category-header::before {
            content: '';
            position: absolute;
            left: 0; bottom: 0; top: 0;
            width: var(--progress-width, 0%);
            background: linear-gradient(90deg, rgba(255, 154, 158, 0.15), rgba(254, 207, 239, 0.15));
            transition: width 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 0;
            pointer-events: none;
        }
        /* å†…å®¹å±‚çº§æå‡ */
        .plan-category-header > * {
            position: relative;
            z-index: 1;
        }
        .plan-category-header:hover {
            background: rgba(255,255,255,0.4);
        }
        .plan-category-group.active .plan-category-header {
            background: rgba(255,255,255,0.5);
        }
        
        .category-title-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .category-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }
        .category-progress-badge {
            font-size: 0.85rem;
            color: var(--text-light);
            background: rgba(255,255,255,0.6);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .header-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s;
            opacity: 0.6;
            color: var(--text-main);
        }
        .plan-category-group.active .header-arrow {
            transform: rotate(180deg);
        }
        
        .plan-category-content {
            display: none;
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
            animation: slideDown 0.3s ease-out;
        }
        .plan-category-group.active .plan-category-content {
            display: block;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .plan-item {
            background: rgba(255,255,255,0.85);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255,255,255,0.6);
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .plan-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background: #ddd;
            transition: background 0.3s;
        }
        .plan-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .plan-item:active { transform: scale(0.98); }
        
        .plan-item.completed {
            background: rgba(255,255,255,0.5);
            opacity: 0.85;
        }
        .plan-item.completed::before { background: var(--success); }
        .plan-item:not(.completed)::before { background: var(--accent-pink); }

        .plan-item-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            width: 100%;
            min-height: 32px;
            cursor: pointer;
        }
        .plan-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--accent-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            background: white;
            margin-top: 2px;
        }
        .plan-checkbox.checked {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
             0% { transform: scale(0.8); }
             50% { transform: scale(1.2); }
             100% { transform: scale(1); }
        }
        .plan-checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            display: none;
            font-weight: bold;
        }
        .plan-checkbox.checked::after {
            display: block;
        }
        .plan-name {
            font-weight: 500;
            color: var(--text-main);
            flex: 1;
            line-height: 1.5;
            word-break: break-word;
            font-size: 1rem;
        }
        .plan-item.completed .plan-name {
            text-decoration: line-through;
            color: var(--text-light);
        }
        .plan-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-left: 36px;
        }
        .plan-progress {
            font-size: 0.85rem;
            color: var(--accent-pink);
            font-weight: bold;
            white-space: nowrap;
        }
        .plan-progress-bar {
            width: 100px;
            height: 8px;
            background: rgba(255,154,158,0.2);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .plan-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9a9e, #fecfef);
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-add-progress {
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(161, 140, 209, 0.3);
        }
        .btn-add-progress:active {
            transform: scale(0.95);
        }
        .plan-item.completed .btn-add-progress {
            display: none;
        }
        .btn-view-records {
            background: rgba(255,255,255,0.8);
            color: var(--accent-pink);
            border: 1px solid var(--accent-pink);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-view-records:hover {
            background: var(--accent-pink);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3);
        }
        .record-item {
            background: rgba(255,255,255,0.7);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .record-item-content {
            flex: 1;
            color: var(--text-main);
            font-size: 0.95rem;
        }
        .record-item-date {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 4px;
        }
        .btn-delete-record {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .btn-delete-record:hover {
            color: var(--danger);
            opacity: 1;
        }
        
        .overall-progress {
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            color: white;
            padding: 20px;
            border-radius: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(161, 140, 209, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .overall-progress::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
            animation: rotate 10s linear infinite;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .overall-progress-content { 
            position: relative; 
            z-index: 2; 
            flex: 1;
        }
        
        .overall-progress-title {
            font-size: 1rem;
            margin-bottom: 5px;
            opacity: 0.95;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .overall-progress-value {
            font-size: 1rem;
            font-weight: 400;
            margin: 5px 0;
            font-family: 'Georgia', serif;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .overall-progress-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* ç¯å½¢è¿›åº¦æ¡ (SVGç‰ˆä¼˜åŒ–) */
        .circular-chart {
            display: block;
            margin: 0 auto;
            max-width: 80px;
            max-height: 80px;
        }
        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 2.5;
        }
        .circle {
            fill: none;
            stroke: white;
            stroke-width: 2.5;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s ease;
        }
        .percentage {
            fill: white;
            font-family: 'Georgia', sans-serif;
            font-weight: bold;
            font-size: 0.5em;
            text-anchor: middle;
        }

        /* ç­›é€‰æ  */
        .filter-bar {
            display: flex;
            justify-content: space-between; /* å·¦å³åˆ†å¸ƒ */
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .filter-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-light);
            background: rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 15px;
            transition: all 0.2s;
        }
        .filter-switch.active {
            background: white;
            color: var(--accent-pink);
            font-weight: bold;
        }
        
        /* æ·»åŠ è®¡åˆ’æŒ‰é’® */
        .btn-add-plan {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(161, 140, 209, 0.4);
            transition: transform 0.2s;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add-plan:active { transform: scale(0.9); }
        
        /* åˆ é™¤æŒ‰é’® */
        .btn-delete-plan {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 6px;
            opacity: 0.4;
            transition: all 0.2s;
            margin-left: auto;
            border-radius: 50%;
        }
        .plan-item:hover .btn-delete-plan { opacity: 1; background: rgba(255,154,158,0.1); }
        .btn-delete-plan:hover { color: var(--danger); transform: scale(1.1); }
        
        /* è¯»åæ„Ÿç›¸å…³æ ·å¼ */
        .btn-view-review {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        .btn-view-review:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-add-review {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border: 1px dashed #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-add-review:hover {
            background: rgba(102, 126, 234, 0.25);
        }
        .review-preview {
            margin-top: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            border-radius: 12px;
            border-left: 3px solid #667eea;
            margin-left: 36px;
        }
        .review-preview-rating {
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .review-preview-content {
            font-size: 0.85rem;
            color: var(--text-main);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .review-preview-more {
            font-size: 0.75rem;
            color: #667eea;
            margin-top: 5px;
            cursor: pointer;
        }
        .review-preview-more:hover {
            text-decoration: underline;
        }
        
        /* å¯æŠ˜å è®°å½•åˆ—è¡¨æ ·å¼ */
        .records-collapsible {
            margin-top: 12px;
            padding-left: 36px;
        }
        .records-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255,255,255,0.4);
            border-radius: 10px;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--text-main);
            user-select: none;
        }
        .records-toggle:hover {
            background: rgba(255,255,255,0.6);
        }
        .records-toggle-icon {
            transition: transform 0.3s;
            font-size: 0.9rem;
        }
        .records-toggle-icon.expanded {
            transform: rotate(90deg);
        }
        .records-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 8px;
        }
        .records-list.expanded {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }
        .record-item-inline {
            background: rgba(255,255,255,0.6);
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid var(--accent-pink);
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .record-item-inline:hover {
            background: rgba(255,255,255,0.8);
            transform: translateX(3px);
        }
        .record-item-inline-content {
            flex: 1;
            color: var(--text-main);
            line-height: 1.4;
        }
        .record-item-inline-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-light);
        }
        .record-item-inline-rating {
            color: #f5a623;
            font-size: 0.8rem;
        }
        .record-item-inline-delete {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 2px 6px;
            opacity: 0.4;
            transition: all 0.2s;
            border-radius: 4px;
        }
        .record-item-inline-delete:hover {
            color: var(--danger);
            opacity: 1;
            background: rgba(255,154,158,0.1);
        }
    </style>
</head>
<body>
<div class="bg-shape shape-1"></div>
<div class="bg-shape shape-2"></div>
<div id="sakura-container"></div>

<div class="container">
    <header>
        <h1>ğŸ“‹ å°å‘¨çš„å¹´åº¦è®¡åˆ’ <span class="version-tag">V3.8</span></h1>
        <div class="love-days">2026å¹´åº¦ç›®æ ‡ ğŸ’•</div>
    </header>

    <div class="nav-tabs">
        <a href="index.html" class="nav-btn">ğŸ  ä¸»é¡µ</a>
        <a href="wishlist.html" class="nav-btn">âœ¨ æ„¿æœ›</a>
        <a href="album.html" class="nav-btn">ğŸ–¼ï¸ ç›¸å†Œ</a>
        <a href="shop.html" class="nav-btn">ğŸ å•†åº—</a>
        <a href="games.html" class="nav-btn">ğŸ® æ¸¸æˆ</a>
        <a href="plan.html" class="nav-btn active">ğŸ“‹ è®¡åˆ’</a>
        <a href="diet.html" class="nav-btn">ğŸ¥— é¥®é£Ÿ</a>
        <a href="settings.html" class="nav-btn">âš™ï¸ è®¾ç½®</a>
    </div>

    <!-- æ€»ä½“è¿›åº¦ -->
    <div class="overall-progress">
        <div class="overall-progress-content">
            <div class="overall-progress-title">å¹´åº¦è®¡åˆ’å®Œæˆåº¦</div>
            <div class="overall-progress-value" id="overall-progress-text">0%</div>
            <div class="overall-progress-subtitle">åšæŒå°±æ˜¯èƒœåˆ©ï¼Œæ…¢æ…¢æ¥ ğŸ’•</div>
        </div>
        <div style="width:80px; height:80px; position:relative;">
            <svg viewBox="0 0 36 36" class="circular-chart">
                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                <path class="circle" id="overall-progress-path" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                <text x="18" y="20.35" class="percentage" id="overall-progress-text-svg">0%</text>
            </svg>
        </div>
    </div>

    <!-- ç­›é€‰ -->
    <div class="filter-bar">
        <div class="filter-switch" id="filter-completed" onclick="app.toggleFilter()">
            <span id="filter-icon">ğŸ‘ï¸</span> <span id="filter-text">æ˜¾ç¤ºå…¨éƒ¨</span>
        </div>
    </div>

    <!-- è®¡åˆ’åˆ—è¡¨ -->
    <div id="plan-list"></div>
</div>

<!-- æ·»åŠ è®¡åˆ’æŒ‰é’® -->
<button class="btn-add-plan" onclick="app.showAddPlanModal()" title="æ·»åŠ æ–°è®¡åˆ’">â•</button>

<!-- æ–°å¢è®¡åˆ’å¼¹çª— -->
<div class="modal-overlay" id="add-plan-modal" style="display:none;" onclick="if(event.target===this) document.getElementById('add-plan-modal').style.display='none'">
    <div class="modal" style="width:90%; max-width:400px; padding:30px 25px;">
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:3.5rem; display:block; margin-bottom:10px;">âœ¨</span>
            <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:1.3rem;">æ·»åŠ æ–°è®¡åˆ’</h3>
            <p style="margin:0; color:var(--text-light); font-size:0.85rem;">è®°å½•ä½ çš„å¹´åº¦ç›®æ ‡ï¼Œä¸€æ­¥æ­¥å®ç°æ¢¦æƒ³</p>
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:6px; color:var(--text-main); font-size:0.9rem; font-weight:500;">ğŸ“ è®¡åˆ’åç§°</label>
            <input type="text" id="plan-name-input" placeholder="ä¾‹å¦‚ï¼šçœ‹ä¸€æ¬¡æ—¥å‡º" style="width:100%; padding:14px; border:2px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.7); border-radius:12px; font-size:1rem; outline:none; transition:all 0.3s; box-sizing:border-box;" onfocus="this.style.borderColor='var(--accent-pink)'; this.style.background='white';" onblur="this.style.borderColor='rgba(255,255,255,0.5)'; this.style.background='rgba(255,255,255,0.7)';">
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:6px; color:var(--text-main); font-size:0.9rem; font-weight:500;">ğŸ“‚ åˆ†ç±»</label>
            <div style="position:relative;">
                <select id="plan-category-select" style="width:100%; padding:14px; border:2px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.7); border-radius:12px; font-size:1rem; outline:none; transition:all 0.3s; box-sizing:border-box; cursor:pointer;" onchange="if(this.value==='custom') app.toggleCustomCategory(true);">
                    <option value="è¯»ä¹¦æ¸…å•ğŸ“–">ğŸ“– è¯»ä¹¦æ¸…å•</option>
                    <option value="ç”µå½±æ¸…å•ğŸ¬">ğŸ¬ ç”µå½±æ¸…å•</option>
                    <option value="ä¼‘é—²å¨±ä¹">ğŸ® ä¼‘é—²å¨±ä¹</option>
                    <option value="èº«ä½“å¥åº·">ğŸ’ª èº«ä½“å¥åº·</option>
                    <option value="æ—¥å¸¸ç”Ÿæ´»">ğŸ  æ—¥å¸¸ç”Ÿæ´»</option>
                    <option value="ä½“éªŒçªç ´">ğŸš€ ä½“éªŒçªç ´</option>
                    <option value="è‡ªæˆ‘æå‡">ğŸ“š è‡ªæˆ‘æå‡</option>
                    <option value="custom">âœ¨ è‡ªå®šä¹‰åˆ†ç±»...</option>
                </select>
                
                <div id="custom-category-wrapper" style="display:none; margin-top:8px;">
                    <input type="text" id="custom-category-input" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°" style="width:100%; padding:14px; border:2px solid var(--accent-pink); background:white; border-radius:12px; font-size:1rem; outline:none; box-sizing:border-box;">
                    <button onclick="app.toggleCustomCategory(false)" style="margin-top:5px; font-size:0.8rem; background:none; border:none; color:var(--text-light); cursor:pointer; text-decoration:underline;">å–æ¶ˆè‡ªå®šä¹‰ï¼Œè¿”å›é€‰æ‹©</button>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:6px; color:var(--text-main); font-size:0.9rem; font-weight:500;">ğŸ¯ ç›®æ ‡æ•°é‡</label>
            <input type="number" id="plan-target-input" placeholder="ä¾‹å¦‚ï¼š1ï¼ˆå•æ¬¡ä»»åŠ¡ï¼‰æˆ– 20ï¼ˆé˜¶æ®µæ€§ä»»åŠ¡ï¼‰" min="1" value="1" style="width:100%; padding:14px; border:2px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.7); border-radius:12px; font-size:1rem; outline:none; transition:all 0.3s; box-sizing:border-box;" onfocus="this.style.borderColor='var(--accent-pink)'; this.style.background='white';" onblur="this.style.borderColor='rgba(255,255,255,0.5)'; this.style.background='rgba(255,255,255,0.7)';">
            <p style="margin:6px 0 0 0; color:var(--text-light); font-size:0.75rem; line-height:1.4;">ğŸ’¡ æç¤ºï¼šè¾“å…¥ 1 è¡¨ç¤ºå•æ¬¡ä»»åŠ¡ï¼ˆå¦‚"çœ‹æ—¥å‡º"ï¼‰ï¼Œè¾“å…¥å¤§äº 1 çš„æ•°å­—è¡¨ç¤ºé˜¶æ®µæ€§ä»»åŠ¡ï¼ˆå¦‚"çœ‹20éƒ¨ç”µå½±"ï¼‰</p>
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:6px; color:var(--text-main); font-size:0.9rem; font-weight:500;">ğŸ¨ å›¾æ ‡ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="plan-icon-input" placeholder="ä¾‹å¦‚ï¼šğŸ“– ğŸ¬ ğŸŒ…" maxlength="2" style="width:100%; padding:14px; border:2px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.7); border-radius:12px; font-size:1.2rem; text-align:center; outline:none; transition:all 0.3s; box-sizing:border-box;" onfocus="this.style.borderColor='var(--accent-pink)'; this.style.background='white';" onblur="this.style.borderColor='rgba(255,255,255,0.5)'; this.style.background='rgba(255,255,255,0.7)';">
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('add-plan-modal').style.display='none'" style="flex:1; background:rgba(255,255,255,0.6); color:var(--text-main); border:2px solid rgba(255,255,255,0.5); padding:14px; border-radius:12px; font-weight:500; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.6)'">å–æ¶ˆ</button>
            <button onclick="app.addNewPlan()" style="flex:1; background:linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:14px; border-radius:12px; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(161,140,209,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='translateY(-2px)'">âœ¨ æ·»åŠ è®¡åˆ’</button>
        </div>
    </div>
</div>

<!-- è®°å½•å†…å®¹å¼¹çª—ï¼ˆç”¨äºé˜¶æ®µæ€§ä»»åŠ¡ï¼‰ -->
<div class="modal-overlay" id="record-modal" style="display:none;" onclick="if(event.target===this) document.getElementById('record-modal').style.display='none'">
    <div class="modal" style="width:90%; max-width:400px; padding:30px 25px;">
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:3rem; display:block; margin-bottom:10px;" id="record-icon">ğŸ¬</span>
            <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:1.2rem;" id="record-title">è®°å½•å®Œæˆå†…å®¹</h3>
            <p style="margin:0; color:var(--text-light); font-size:0.85rem;" id="record-hint">å¡«å†™å…·ä½“å†…å®¹ï¼Œä¾‹å¦‚ç”µå½±åç§°</p>
        </div>
        
        <div style="margin-bottom:20px;">
            <input type="text" id="record-content-input" placeholder="ä¾‹å¦‚ï¼šã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹" style="width:100%; padding:14px; border:2px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.7); border-radius:12px; font-size:1rem; outline:none; transition:all 0.3s; box-sizing:border-box;" onfocus="this.style.borderColor='var(--accent-pink)'; this.style.background='white';" onblur="this.style.borderColor='rgba(255,255,255,0.5)'; this.style.background='rgba(255,255,255,0.7)';">
        </div>
        
        <div style="display:flex; gap:10px;" id="record-modal-buttons">
            <button onclick="app.skipRecord()" id="record-skip-btn" style="display:none; flex:1; background:rgba(255,255,255,0.6); color:var(--text-main); border:2px solid rgba(255,255,255,0.5); padding:14px; border-radius:12px; font-weight:500; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.6)'">è·³è¿‡è®°å½•</button>
            <button onclick="document.getElementById('record-modal').style.display='none'" id="record-cancel-btn" style="flex:1; background:rgba(255,255,255,0.6); color:var(--text-main); border:2px solid rgba(255,255,255,0.5); padding:14px; border-radius:12px; font-weight:500; cursor:pointer;">å–æ¶ˆ</button>
            <button onclick="app.confirmRecord()" style="flex:1; background:linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:14px; border-radius:12px; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(161,140,209,0.3);">âœ“ ç¡®è®¤è®°å½•</button>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹è®°å½•åˆ—è¡¨å¼¹çª— -->
<div class="modal-overlay" id="records-list-modal" style="display:none;" onclick="if(event.target===this) document.getElementById('records-list-modal').style.display='none'">
    <div class="modal" style="width:90%; max-width:400px; padding:25px; max-height:70vh; overflow-y:auto;">
        <div style="text-align:center; margin-bottom:20px;">
            <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:1.2rem;" id="records-list-title">å·²å®Œæˆè®°å½•</h3>
        </div>
        <div id="records-list-content" style="max-height:50vh; overflow-y:auto;"></div>
        <button onclick="document.getElementById('records-list-modal').style.display='none'" style="width:100%; margin-top:15px; background:linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">å…³é—­</button>
    </div>
</div>

<!-- è¯»åæ„Ÿå¼¹çª— -->
<div class="modal-overlay" id="review-modal" style="display:none;" onclick="if(event.target===this) document.getElementById('review-modal').style.display='none'">
    <div class="modal" style="width:90%; max-width:450px; padding:30px 25px;">
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:3rem; display:block; margin-bottom:10px;">ğŸ“–âœ¨</span>
            <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:1.2rem;" id="review-title">å†™ä¸‹è¯»åæ„Ÿ</h3>
            <p style="margin:0; color:var(--text-light); font-size:0.85rem;" id="review-book-name">ã€Šä¹¦åã€‹</p>
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:6px; color:var(--text-main); font-size:0.9rem; font-weight:500;">â­ è¯„åˆ†</label>
            <div id="review-rating" style="display:flex; gap:8px; justify-content:center; margin-bottom:10px;">
                <span class="rating-star" data-rating="1" onclick="app.setReviewRating(1)" style="font-size:1.8rem; cursor:pointer; opacity:0.3; transition:all 0.2s;">â­</span>
                <span class="rating-star" data-rating="2" onclick="app.setReviewRating(2)" style="font-size:1.8rem; cursor:pointer; opacity:0.3; transition:all 0.2s;">â­</span>
                <span class="rating-star" data-rating="3" onclick="app.setReviewRating(3)" style="font-size:1.8rem; cursor:pointer; opacity:0.3; transition:all 0.2s;">â­</span>
                <span class="rating-star" data-rating="4" onclick="app.setReviewRating(4)" style="font-size:1.8rem; cursor:pointer; opacity:0.3; transition:all 0.2s;">â­</span>
                <span class="rating-star" data-rating="5" onclick="app.setReviewRating(5)" style="font-size:1.8rem; cursor:pointer; opacity:0.3; transition:all 0.2s;">â­</span>
            </div>
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:6px; color:var(--text-main); font-size:0.9rem; font-weight:500;">ğŸ’­ è¯»åæ„Ÿæƒ³</label>
            <textarea id="review-content-input" placeholder="è¿™æœ¬ä¹¦ç»™ä½ å¸¦æ¥äº†ä»€ä¹ˆæ„Ÿæ‚Ÿï¼Ÿè®°å½•ä¸‹æ¥å§..." rows="5" style="width:100%; padding:14px; border:2px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.7); border-radius:12px; font-size:1rem; outline:none; transition:all 0.3s; box-sizing:border-box; resize:vertical; min-height:100px; line-height:1.6;" onfocus="this.style.borderColor='var(--accent-pink)'; this.style.background='white';" onblur="this.style.borderColor='rgba(255,255,255,0.5)'; this.style.background='rgba(255,255,255,0.7)'"></textarea>
            <p style="margin:6px 0 0 0; color:var(--text-light); font-size:0.75rem;">ğŸ’¡ å¯ä»¥è®°å½•ï¼šå°è±¡æ·±åˆ»çš„å¥å­ã€è¯»ä¹¦å¿ƒå¾—ã€æ¨èç†ç”±ç­‰</p>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="app.skipReview()" style="flex:1; background:rgba(255,255,255,0.6); color:var(--text-main); border:2px solid rgba(255,255,255,0.5); padding:14px; border-radius:12px; font-weight:500; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.6)'">æš‚æ—¶è·³è¿‡</button>
            <button onclick="app.saveReview()" style="flex:1; background:linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:14px; border-radius:12px; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(161,140,209,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ’¾ ä¿å­˜è¯»åæ„Ÿ</button>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹è¯»åæ„Ÿå¼¹çª— -->
<div class="modal-overlay" id="view-review-modal" style="display:none;" onclick="if(event.target===this) document.getElementById('view-review-modal').style.display='none'">
    <div class="modal" style="width:90%; max-width:450px; padding:30px 25px; max-height:80vh; overflow-y:auto;">
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:2.5rem; display:block; margin-bottom:10px;">ğŸ“–</span>
            <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:1.2rem;" id="view-review-title">ã€Šä¹¦åã€‹</h3>
            <div id="view-review-rating" style="margin:10px 0;"></div>
            <p style="margin:0; color:var(--text-light); font-size:0.8rem;" id="view-review-date">å®Œæˆäº 2026-01-01</p>
        </div>
        
        <div style="background:rgba(255,255,255,0.5); border-radius:15px; padding:20px; margin-bottom:20px; border-left:4px solid var(--accent-pink);">
            <div style="font-size:0.85rem; color:var(--text-light); margin-bottom:8px;">ğŸ’­ è¯»åæ„Ÿ</div>
            <div id="view-review-content" style="color:var(--text-main); line-height:1.8; white-space:pre-wrap; font-size:0.95rem;"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="app.editReview()" style="flex:1; background:rgba(255,255,255,0.6); color:var(--accent-pink); border:2px solid var(--accent-pink); padding:12px; border-radius:12px; font-weight:500; cursor:pointer; transition:all 0.2s;">âœï¸ ç¼–è¾‘</button>
            <button onclick="document.getElementById('view-review-modal').style.display='none'" style="flex:1; background:linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<script src="js/core/sound-manager.js"></script>
<script src="js/core/storage.js"></script>
<script src="js/core/utils.js"></script>
<script src="js/core/constants.js"></script>
<script src="js/ui/ui-manager.js"></script>
<script src="common.js"></script>
<script>
// å¹´åº¦è®¡åˆ’åˆå§‹æ•°æ®
const annualPlanTemplate = [
    // ä¸€ã€è¯»ä¹¦æ¸…å•ğŸ“–ï¼ˆ15æœ¬ï¼‰
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šæ´»ç€ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šå…„å¼Ÿã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šè¢«è®¨åŒçš„å‹‡æ°”ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šè¥¿è¥¿å¼—ç¥è¯ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šç“¦å°”ç™»æ¹–ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šç™¾å¹´å­¤ç‹¬ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šå›´åŸã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šæˆ‘ä¸åœ°å›ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šæ–‡åŒ–è‹¦æ—…ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šæ‚‰è¾¾å¤šã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šç‰›è™»ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šç›¸çº¦æ˜ŸæœŸäºŒã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    { category: 'è¯»ä¹¦æ¸…å•ğŸ“–', name: 'ã€Šè€å®äººå¯è’™ã€‹', target: 1, current: 0, completed: false, icon: 'ğŸ“–' },
    
    // äºŒã€ç”µå½±æ¸…å•ğŸ¬ï¼ˆ20éƒ¨ï¼‰
    { category: 'ç”µå½±æ¸…å•ğŸ¬', name: 'çœ‹ç”µå½±', target: 20, current: 0, completed: false, icon: 'ğŸ¬' },
    
    // ä¸‰ã€ä¼‘é—²å¨±ä¹
    { category: 'ä¼‘é—²å¨±ä¹', name: 'çœ‹ä¸€æ¬¡æ—¥å‡ºğŸŒ…', target: 1, current: 0, completed: false, icon: 'ğŸŒ…' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'çœ‹ä¸€æ¬¡æ—¥è½ğŸŒ„', target: 1, current: 0, completed: false, icon: 'ğŸŒ„' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'çœ‹ä¸€åœºçƒŸèŠ±ğŸ†', target: 1, current: 0, completed: false, icon: 'ğŸ†' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'æ»‘é›ª', target: 1, current: 0, completed: false, icon: 'â›·ï¸' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'å¡ä¸è½¦', target: 1, current: 0, completed: false, icon: 'ğŸï¸' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'å°„ç®­', target: 1, current: 0, completed: false, icon: 'ğŸ¹' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'æ”€å²©', target: 1, current: 0, completed: false, icon: 'ğŸ§—' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'å±±é—´æ°‘å®¿ä½“éªŒ', target: 1, current: 0, completed: false, icon: 'ğŸ¡' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'æ”¾é£ç­ğŸª', target: 1, current: 0, completed: false, icon: 'ğŸª' },
    { category: 'ä¼‘é—²å¨±ä¹', name: 'æŒ‰æ‘©ğŸ’†â€â™€ï¸', target: 1, current: 0, completed: false, icon: 'ğŸ’†â€â™€ï¸' },
    
    // å››ã€èº«ä½“å¥åº·
    { category: 'èº«ä½“å¥åº·', name: 'ç˜¦åˆ°105æ–¤', target: 1, current: 0, completed: false, icon: 'âš–ï¸' },
    { category: 'èº«ä½“å¥åº·', name: 'éª‘è½¦20æ¬¡ğŸš´', target: 20, current: 0, completed: false, icon: 'ğŸš´' },
    { category: 'èº«ä½“å¥åº·', name: 'ä¸€å‘¨æ— éº¸è´¨é¥®é£Ÿ', target: 1, current: 0, completed: false, icon: 'ğŸ¥—' },
    { category: 'èº«ä½“å¥åº·', name: 'æŒ‘æˆ˜ä¸€ä¸ªæœˆä¸å–å¥¶èŒ¶ğŸ¥¤', target: 1, current: 0, completed: false, icon: 'ğŸ¥¤' },
    { category: 'èº«ä½“å¥åº·', name: 'æŒ‘æˆ˜ä¸€ä¸ªæœˆä¸åƒç”œå“ğŸ®', target: 1, current: 0, completed: false, icon: 'ğŸ®' },
    { category: 'èº«ä½“å¥åº·', name: 'ç§ç‰™ğŸ¦·', target: 1, current: 0, completed: false, icon: 'ğŸ¦·' },
    { category: 'èº«ä½“å¥åº·', name: 'ä¹ä»·ğŸ’‰', target: 1, current: 0, completed: false, icon: 'ğŸ’‰' },
    
    // äº”ã€æ—¥å¸¸ç”Ÿæ´»
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'å¹³å¸¸çš„æ—¥å­é‡Œæ—©èµ·ä¸€å‘¨', target: 1, current: 0, completed: false, icon: 'ğŸŒ…' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'æ‹ä¸ªå†™çœŸ', target: 1, current: 0, completed: false, icon: 'ğŸ“¸' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'å»ä¸€ä¸ªæ–°åŸå¸‚æ—…æ¸¸', target: 1, current: 0, completed: false, icon: 'âœˆï¸' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'è¿œè·ç¦»æ—…æ¸¸ä¸€æ¬¡', target: 1, current: 0, completed: false, icon: 'ğŸŒ' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'çˆ¬3åº§å±±', target: 3, current: 0, completed: false, icon: 'â›°ï¸' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'çœ‹ä¸€æ¬¡æµ·', target: 1, current: 0, completed: false, icon: 'ğŸŒŠ' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'å­¦ä¼šæ¸¸æ³³', target: 1, current: 0, completed: false, icon: 'ğŸŠ' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'æ¯æœˆä¹°ä¸€æŸèŠ±', target: 12, current: 0, completed: false, icon: 'ğŸŒ¸' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'æ—©èµ·å»æ—©å¸‚æ„Ÿå—çƒŸç«æ°”', target: 1, current: 0, completed: false, icon: 'ğŸŒ†' },
    { category: 'æ—¥å¸¸ç”Ÿæ´»', name: 'æŒ‘æˆ˜ä¸€ä¸ªæœˆä¸ç½‘è´­', target: 1, current: 0, completed: false, icon: 'ğŸ›’' },
    
    // å…­ã€ä½“éªŒçªç ´
    { category: 'ä½“éªŒçªç ´', name: 'æ‰¾ä¸€ç™¾ä½é™Œç”Ÿäººè¯´è¯ğŸ—£ï¸', target: 100, current: 0, completed: false, icon: 'ğŸ—£ï¸' },
    { category: 'ä½“éªŒçªç ´', name: 'çœ‹ä¸€æ¬¡è¯å‰§', target: 1, current: 0, completed: false, icon: 'ğŸ­' },
    { category: 'ä½“éªŒçªç ´', name: 'éšæœºå…¬äº¤ä¸‹ç«™æ„Ÿå—ç”Ÿæ´»', target: 1, current: 0, completed: false, icon: 'ğŸšŒ' },
    { category: 'ä½“éªŒçªç ´', name: 'è¶…é•¿è·ç¦»éª‘è¡Œ', target: 1, current: 0, completed: false, icon: 'ğŸš´' },
    { category: 'ä½“éªŒçªç ´', name: 'æˆ·å¤–éœ²è¥ğŸ•ï¸', target: 1, current: 0, completed: false, icon: 'ğŸ•ï¸' },
    { category: 'ä½“éªŒçªç ´', name: 'å®Œæˆåå…¬é‡Œä»¥ä¸Šçš„å¾’æ­¥', target: 1, current: 0, completed: false, icon: 'ğŸ¥¾' },
    { category: 'ä½“éªŒçªç ´', name: 'æœ¬äººå¼€è½¦è‡ªé©¾æ¸¸', target: 1, current: 0, completed: false, icon: 'ğŸš—' },
    { category: 'ä½“éªŒçªç ´', name: 'ä¸€ä¸ªäººè‡ªç”±è¡Œ', target: 1, current: 0, completed: false, icon: 'ğŸ’' },
    { category: 'ä½“éªŒçªç ´', name: 'å»é…’å§', target: 1, current: 0, completed: false, icon: 'ğŸ·' },
    { category: 'ä½“éªŒçªç ´', name: 'å­¦ä¸€æ”¯ç®€å•çš„èˆè¹ˆğŸ’ƒ', target: 1, current: 0, completed: false, icon: 'ğŸ’ƒ' },
    { category: 'ä½“éªŒçªç ´', name: 'æ‹¿ç€ç›¸æœºå»æ‰«è¡—', target: 1, current: 0, completed: false, icon: 'ğŸ“·' },
    { category: 'ä½“éªŒçªç ´', name: 'æŒ‘æˆ˜ä¸€å‘¨åªèŠ±80', target: 1, current: 0, completed: false, icon: 'ğŸ’°' },
    { category: 'ä½“éªŒçªç ´', name: 'ç»™äº”å¹´åçš„è‡ªå·±å†™ä¸€å°ä¿¡', target: 1, current: 0, completed: false, icon: 'âœ‰ï¸' },
    
    // ä¸ƒã€è‡ªæˆ‘æå‡
    { category: 'è‡ªæˆ‘æå‡', name: 'æ¯æœˆå†™ä¸€ç¯‡åæ€æ€»ç»“', target: 12, current: 0, completed: false, icon: 'âœï¸' },
    { category: 'è‡ªæˆ‘æå‡', name: 'å»å›¾ä¹¦é¦†çœ‹ä¸€å¤©ä¹¦', target: 1, current: 0, completed: false, icon: 'ğŸ“š' }
];

Object.assign(app, {
    currentCategory: null, // å·²åºŸå¼ƒï¼Œæ”¹ä¸º expandedCategories
    expandedCategories: new Set(['ä¼‘é—²å¨±ä¹']), // é»˜è®¤å±•å¼€çš„åˆ†ç±»
    pendingRecordItemId: null, // å¾…è®°å½•å†…å®¹çš„è®¡åˆ’ID
    hideCompleted: false, // æ˜¯å¦éšè—å·²å®Œæˆ
    pendingReviewItemId: null, // å¾…å†™è¯»åæ„Ÿçš„è®¡åˆ’ID
    currentReviewRating: 0, // å½“å‰é€‰æ‹©çš„è¯„åˆ†
    isEditingReview: false, // æ˜¯å¦æ­£åœ¨ç¼–è¾‘è¯»åæ„Ÿ
    
    init() {
        this.initCommon();
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½
        setTimeout(() => {
            this.initAnnualPlan();
            this.render();
        }, 200);
    },

    // åˆå§‹åŒ–å¹´åº¦è®¡åˆ’æ•°æ®
    initAnnualPlan() {
        // ç¡®ä¿ annualPlan å­—æ®µå­˜åœ¨
        if (!this.data.annualPlan) {
            this.data.annualPlan = [];
        }
        
        if (this.data.annualPlan.length === 0) {
            // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆå§‹åŒ–æ•°æ®
            this.data.annualPlan = annualPlanTemplate.map((item, index) => ({
                id: Date.now() + index,
                ...item,
                records: [] // åˆå§‹åŒ–recordså­—æ®µ
            }));
            this.saveData();
        } else {
            // ç¡®ä¿å·²æœ‰æ•°æ®åŒ…å«recordså­—æ®µ
            this.data.annualPlan.forEach(item => {
                if (!item.records) {
                    item.records = [];
                }
            });
            
            // å»é‡ï¼šç§»é™¤é‡å¤çš„è®¡åˆ’é¡¹ï¼ˆæ ¹æ® category + name åˆ¤æ–­ï¼‰
            const originalLength = this.data.annualPlan.length;
            const seen = new Map();
            this.data.annualPlan = this.data.annualPlan.filter(item => {
                const key = `${item.category}|${item.name}`;
                if (seen.has(key)) {
                    // ä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤åç»­é‡å¤çš„
                    return false;
                }
                seen.set(key, true);
                return true;
            });
            const afterDedupLength = this.data.annualPlan.length;
            const hasDuplicates = originalLength > afterDedupLength;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢çš„ä»»åŠ¡ï¼ˆé€šè¿‡æ¯”è¾ƒæ•°é‡ï¼‰
            let hasNewItems = false;
            if (this.data.annualPlan.length < annualPlanTemplate.length) {
                // åˆå¹¶æ–°ä»»åŠ¡
                annualPlanTemplate.forEach(template => {
                    const exists = this.data.annualPlan.find(p => 
                        p.category === template.category && p.name === template.name
                    );
                    if (!exists) {
                        hasNewItems = true;
                        this.data.annualPlan.push({
                            id: Date.now() + Math.random(),
                            ...template,
                            records: [] // åˆå§‹åŒ–recordså­—æ®µ
                        });
                    }
                });
            }
            
            // å¦‚æœæœ‰å»é‡æˆ–æ–°å¢ï¼Œä¿å­˜æ•°æ®
            if (hasDuplicates || hasNewItems) {
                this.saveData();
            }
        }
    },

    // åˆ‡æ¢ç­›é€‰çŠ¶æ€
    toggleFilter() {
        this.hideCompleted = !this.hideCompleted;
        const icon = document.getElementById('filter-icon');
        const text = document.getElementById('filter-text');
        const btn = document.getElementById('filter-completed');
        
        if (this.hideCompleted) {
            icon.innerText = 'ğŸ™ˆ';
            text.innerText = 'éšè—å·²å®Œæˆ';
            btn.classList.add('active');
        } else {
            icon.innerText = 'ğŸ‘ï¸';
            text.innerText = 'æ˜¾ç¤ºå…¨éƒ¨';
            btn.classList.remove('active');
        }
        this.render();
    },

    render() {
        const planList = document.getElementById('plan-list');
        if (!planList) return;

        // ç¡®ä¿æ•°æ®å·²åˆå§‹åŒ–
        if (!this.data.annualPlan || this.data.annualPlan.length === 0) {
            planList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-light);">æ­£åœ¨åŠ è½½è®¡åˆ’æ•°æ®...</div>';
            return;
        }

        // æŒ‰åˆ†ç±»åˆ†ç»„
        const categories = {};
        this.data.annualPlan.forEach(item => {
            if (!categories[item.category]) {
                categories[item.category] = [];
            }
            categories[item.category].push(item);
        });

        // è·å–æ‰€æœ‰åˆ†ç±»
        const allCategories = Object.keys(categories).sort();
        
        // æ¸²æŸ“è®¡åˆ’åˆ—è¡¨ï¼ˆæŠ˜å é¢æ¿å½¢å¼ï¼‰
        let html = '';
        allCategories.forEach(category => {
            let items = categories[category];
            // ç­›é€‰å·²å®Œæˆ
            if (this.hideCompleted) {
                items = items.filter(i => !i.completed);
            }
            
            // è®¡ç®—å½“å‰æ˜¾ç¤ºçš„å®Œæˆè¿›åº¦
            const total = this.data.annualPlan.filter(i => i.category === category).length;
            const completed = this.data.annualPlan.filter(i => i.category === category && i.completed).length;
            
            // æ£€æŸ¥æ˜¯å¦å±•å¼€
            const isExpanded = this.expandedCategories.has(category);
            
            // è®¡ç®—åˆ†ç±»å®Œæˆåº¦ç™¾åˆ†æ¯”ï¼ˆç”¨äºèƒŒæ™¯è¿›åº¦æ¡ï¼‰
            const categoryPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            html += `
                <div class="plan-category-group ${isExpanded ? 'active' : ''}" id="category-group-${category}">
                    <div class="plan-category-header" onclick="app.toggleCategory('${category}')" style="--progress-width: ${categoryPercent}%">
                        <div class="category-title-wrapper">
                            <span class="category-title">${category}</span>
                            <span class="category-progress-badge">${completed}/${total}</span>
                        </div>
                        <div class="header-arrow">â–¼</div>
                    </div>
                    <div class="plan-category-content">
            `;
            
            if (items.length === 0) {
                 html += '<div style="text-align:center; padding:20px; color:var(--text-light); font-size:0.9rem;">æš‚æ— è®¡åˆ’æˆ–å·²éšè—å®Œæˆé¡¹</div>';
            } else {
                items.forEach(item => {
                    const isCompleted = item.completed;
                    const progress = item.target > 1 ? `${item.current}/${item.target}` : '';
                    const progressPercent = item.target > 1 ? Math.min(100, (item.current / item.target) * 100) : (isCompleted ? 100 : 0);
                    const records = item.records || [];
                    const hasRecords = records.length > 0;
                    const isBook = item.category === 'è¯»ä¹¦æ¸…å•ğŸ“–' && item.target === 1;
                    const hasReview = item.review && item.review.content;
                    
                    html += `
                        <div class="plan-item ${isCompleted ? 'completed' : ''}">
                            <div class="plan-item-content" onclick="app.togglePlanItem(${item.id})">
                                <div class="plan-checkbox ${isCompleted ? 'checked' : ''}"></div>
                                <span class="plan-name">${item.icon} ${item.name}</span>
                                <button class="btn-delete-plan" onclick="event.stopPropagation(); app.deletePlan(${item.id})" title="åˆ é™¤è®¡åˆ’">ğŸ—‘ï¸</button>
                            </div>
                            ${item.target > 1 ? `
                                <div class="plan-actions">
                                    <div class="plan-progress-bar">
                                        <div class="plan-progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <span class="plan-progress">${progress}</span>
                                    ${!isCompleted ? `<button class="btn-add-progress" onclick="event.stopPropagation(); app.addProgress(${item.id})">+1</button>` : ''}
                                    ${hasRecords ? `<button class="btn-view-records" onclick="event.stopPropagation(); app.viewRecords(${item.id})" title="æŸ¥çœ‹å®Œæ•´è®°å½•">ğŸ“‹</button>` : ''}
                                </div>
                                ${hasRecords ? `
                                    <div class="records-collapsible">
                                        <div class="records-toggle" onclick="app.toggleRecordsList(${item.id})">
                                            <span class="records-toggle-icon" id="toggle-icon-${item.id}">â–¶</span>
                                            <span>å·²è®°å½• ${records.length} é¡¹</span>
                                        </div>
                                        <div class="records-list" id="records-list-${item.id}">
                                            ${records.map((record, index) => {
                                                const hasRating = record.rating && record.rating > 0;
                                                const hasComment = record.comment && record.comment.trim();
                                                return `
                                                    <div class="record-item-inline">
                                                        <div class="record-item-inline-content">
                                                            <div style="font-weight:500; margin-bottom:4px;">${index + 1}. ${record.content}</div>
                                                            ${hasComment ? `<div style="color:var(--text-light); font-size:0.8rem; margin-top:4px; padding-left:8px; border-left:2px solid rgba(255,154,158,0.3);">ğŸ’¬ ${record.comment}</div>` : ''}
                                                        </div>
                                                        <div class="record-item-inline-meta">
                                                            ${hasRating ? `<span class="record-item-inline-rating">${'â­'.repeat(record.rating)}</span>` : ''}
                                                            <span>${record.date}</span>
                                                            <button class="record-item-inline-delete" onclick="event.stopPropagation(); app.deleteRecord(${item.id}, ${index})" title="åˆ é™¤è®°å½•">ğŸ—‘ï¸</button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            ` : ''}
                            ${isBook && isCompleted ? `
                                <div class="plan-actions" style="margin-top:12px;">
                                    ${hasReview ? `
                                        <button class="btn-view-review" onclick="event.stopPropagation(); app.viewReview(${item.id})">ğŸ“ æŸ¥çœ‹è¯»åæ„Ÿ</button>
                                    ` : `
                                        <button class="btn-add-review" onclick="event.stopPropagation(); app.showReviewModal(${item.id})">âœï¸ å†™è¯»åæ„Ÿ</button>
                                    `}
                                </div>
                                ${hasReview ? `
                                    <div class="review-preview" onclick="app.viewReview(${item.id})" style="cursor:pointer;">
                                        <div class="review-preview-rating">${'â­'.repeat(item.review.rating || 0)}</div>
                                        <div class="review-preview-content">${item.review.content}</div>
                                        <div class="review-preview-more">ç‚¹å‡»æŸ¥çœ‹å®Œæ•´è¯»åæ„Ÿ â†’</div>
                                    </div>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = '<div style="text-align:center; padding:40px; color:var(--text-light);">ğŸ‰ è¿™é‡Œçš„è®¡åˆ’éƒ½å®Œæˆå•¦ï¼<br>ï¼ˆæˆ–è€…è¢«éšè—äº†å“¦ï¼‰</div>';
        }

        planList.innerHTML = html;

        // æ›´æ–°æ€»ä½“è¿›åº¦
        this.updateOverallProgress();
    },

    // åˆ‡æ¢åˆ†ç±»æŠ˜å çŠ¶æ€
    toggleCategory(category) {
        if (this.expandedCategories.has(category)) {
            this.expandedCategories.delete(category);
        } else {
            this.expandedCategories.add(category);
        }
        this.render();
    },
    
    // åˆ‡æ¢è®°å½•åˆ—è¡¨æŠ˜å çŠ¶æ€
    toggleRecordsList(id) {
        const listEl = document.getElementById(`records-list-${id}`);
        const iconEl = document.getElementById(`toggle-icon-${id}`);
        
        if (listEl && iconEl) {
            const isExpanded = listEl.classList.contains('expanded');
            if (isExpanded) {
                listEl.classList.remove('expanded');
                iconEl.classList.remove('expanded');
            } else {
                listEl.classList.add('expanded');
                iconEl.classList.add('expanded');
            }
        }
    },

    // åˆ‡æ¢å•æ¬¡ä»»åŠ¡å®ŒæˆçŠ¶æ€
    togglePlanItem(id) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item) return;
        
        // å¦‚æœæ˜¯é˜¶æ®µæ€§ä»»åŠ¡ï¼ˆtarget > 1ï¼‰ï¼Œç‚¹å‡»ä¸åˆ‡æ¢å®ŒæˆçŠ¶æ€ï¼Œåªæ˜¾ç¤ºè¿›åº¦
        if (item.target > 1) {
            return;
        }
        
        // å•æ¬¡ä»»åŠ¡ï¼šç‚¹å‡»è§¦å‘å®Œæˆç¡®è®¤å’Œæ„Ÿå—è®°å½•
        if (!item.completed) {
            // å¼¹å‡ºè®°å½•å¼¹çª—ï¼Œç¡®è®¤åæ‰ç®—å®Œæˆ
            this.pendingRecordItemId = id;
            this.isMovieRecord = false;
            this.currentMovieRating = 0;
            
            const recordIconEl = document.getElementById('record-icon');
            const recordTitleEl = document.getElementById('record-title');
            if (recordIconEl) recordIconEl.innerText = item.icon;
            if (recordTitleEl) recordTitleEl.innerText = `å®Œæˆï¼š${item.name}`;
            
            const recordHintEl = document.getElementById('record-hint');
            const recordContentInputEl = document.getElementById('record-content-input');
            const recordNameLabelEl = document.getElementById('record-name-label');
            const movieRatingSectionEl = document.getElementById('movie-rating-section');
            const movieCommentSectionEl = document.getElementById('movie-comment-section');
            const recordCommentInputEl = document.getElementById('record-comment-input');
            
            if (recordHintEl) recordHintEl.innerText = 'å†™ä¸‹å®Œæˆè¿™ä¸€åˆ»çš„æ„Ÿå—å§ï¼ˆå¯é€‰ï¼‰';
            if (recordContentInputEl) {
                recordContentInputEl.value = '';
                recordContentInputEl.placeholder = 'ä¾‹å¦‚ï¼šéå¸¸å¼€å¿ƒï¼Œç»ˆäºåšåˆ°äº†ï¼';
            }
            if (recordNameLabelEl) recordNameLabelEl.innerText = 'ğŸ“ æ­¤åˆ»æ„Ÿå—';
            
            // éšè—è¯„åˆ†åŒºåŸŸï¼ˆå•æ¬¡ä»»åŠ¡é€šå¸¸ä¸éœ€è¦è¯„åˆ†ï¼Œé™¤éæ˜¯ä¹¦/ç”µå½±ï¼Œä½†é‚£äº›å·²ç‰¹æ®Šå¤„ç†ï¼‰
            if (movieRatingSectionEl) movieRatingSectionEl.style.display = 'none';
            if (movieCommentSectionEl) movieCommentSectionEl.style.display = 'none';
            
            // æ˜¾ç¤ºè·³è¿‡æŒ‰é’®ï¼ˆå…è®¸ä¸å†™æ„Ÿå—ç›´æ¥å®Œæˆï¼‰
            const skipBtn = document.getElementById('record-skip-btn');
            const cancelBtn = document.getElementById('record-cancel-btn');
            if (skipBtn) {
                skipBtn.style.display = 'block';
                skipBtn.innerText = 'ç›´æ¥å®Œæˆ';
                skipBtn.onclick = () => {
                    this.completeSingleItem(id, null);
                    document.getElementById('record-modal').style.display = 'none';
                };
            }
            if (cancelBtn) cancelBtn.style.flex = '0.5';
            
            document.getElementById('record-modal').style.display = 'flex';
            if (recordContentInputEl) recordContentInputEl.focus();
            
        } else {
            // å–æ¶ˆå®Œæˆ
            if (confirm(`ç¡®å®šè¦å°†"${item.name}"æ ‡è®°ä¸ºæœªå®Œæˆå—ï¼Ÿ`)) {
                item.completed = false;
                item.current = 0;
                this.saveData();
                this.render();
            }
        }
    },

    // æ‰§è¡Œå•æ¬¡ä»»åŠ¡å®Œæˆé€»è¾‘
    completeSingleItem(id, recordData) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item) return;

        item.completed = true;
        item.current = 1;
        
        // ä¿å­˜è®°å½•
        if (recordData) {
            if (!item.records) item.records = [];
            // recordData å¯èƒ½æ˜¯å¯¹è±¡æˆ–å­—ç¬¦ä¸²
            if (typeof recordData === 'string') {
                 item.records.push({
                    content: recordData,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                });
            } else {
                item.records.push(recordData);
            }
        }

        uiManager.createPetal();
        uiManager.createPetal();
        this.showToast(`å¤ªæ£’äº†ï¼å®Œæˆäº†ï¼š${item.name} ğŸ‰`);
        
        this.saveData();
        this.render();
        
        // å¦‚æœæ˜¯ä¹¦å•é¡¹ç›®ï¼Œä¸”æ²¡æœ‰è®°å½•ï¼ˆæˆ–è€…è®°å½•äº†ä½†æƒ³å†™æ›´è¯¦ç»†çš„è¯»åæ„Ÿï¼‰ï¼Œå¯ä»¥å»¶è¿Ÿå¼¹å‡ºè¯»åæ„Ÿ
        // è¿™é‡Œç­–ç•¥æ˜¯ï¼šæ—¢ç„¶å·²ç»å¼¹å‡ºäº†æ„Ÿå—è®°å½•ï¼Œå°±ä¸å†å¼¹è¯»åæ„Ÿäº†ï¼Œé™¤éç”¨æˆ·ä¸»åŠ¨å»ç‚¹â€œå†™è¯»åæ„Ÿâ€
        // æˆ–è€…æˆ‘ä»¬å¯ä»¥è®©ä¹¦å•ä»»åŠ¡åœ¨è®°å½•æ—¶ç›´æ¥å°±æ˜¯å†™è¯»åæ„Ÿï¼ˆå¤ç”¨ review å­—æ®µï¼‰
        // é‰´äºç›®å‰ records å’Œ review å¹¶å­˜ï¼Œæˆ‘ä»¬ç®€å•å¤„ç†ï¼šæ‰€æœ‰è®°å½•éƒ½è¿› records
        // å¦‚æœæ˜¯ä¹¦å•ï¼Œrecords é‡Œçš„å†…å®¹ä¹Ÿå¯ä»¥è§†ä¸ºç®€çŸ­è¯»åæ„Ÿ
    },

    // å¢åŠ é˜¶æ®µæ€§ä»»åŠ¡è¿›åº¦
    addProgress(id) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item || item.target <= 1) return;
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è®°å½•å†…å®¹ï¼ˆç”µå½±æ¸…å•ã€è¯»ä¹¦æ¸…å•å¿…é¡»è®°å½•ï¼Œå…¶ä»–ä»»åŠ¡å¯é€‰è®°å½•ï¼‰
        const mustRecord = item.category === 'ç”µå½±æ¸…å•ğŸ¬' || item.category === 'è¯»ä¹¦æ¸…å•ğŸ“–';
        const isMovie = item.category === 'ç”µå½±æ¸…å•ğŸ¬';
        
        // æ‰€æœ‰é˜¶æ®µæ€§ä»»åŠ¡éƒ½å¼¹å‡ºè®°å½•æ¡†ï¼ˆç”µå½±/ä¹¦ç±å¿…é¡»è®°å½•ï¼Œå…¶ä»–å¯é€‰ï¼‰
        this.pendingRecordItemId = id;
        this.isMovieRecord = isMovie;
        this.editingRecordIndex = -1; // -1 è¡¨ç¤ºæ–°å¢
        this.currentMovieRating = 0;
        
        const recordIconEl = document.getElementById('record-icon');
        const recordTitleEl = document.getElementById('record-title');
        if (recordIconEl) recordIconEl.innerText = item.icon;
        if (recordTitleEl) recordTitleEl.innerText = `è®°å½•${item.name}`;
        
        let hintText = '';
        if (isMovie) {
            hintText = 'å¡«å†™ç”µå½±åç§°ï¼Œæ‰“åˆ†å¹¶å†™ä¸‹çŸ­è¯„';
        } else if (item.category === 'è¯»ä¹¦æ¸…å•ğŸ“–') {
            hintText = 'å¡«å†™ä¹¦åï¼Œä¾‹å¦‚ï¼šã€Šæ´»ç€ã€‹';
        } else {
            hintText = 'è®°å½•æœ¬æ¬¡å®Œæˆçš„å†…å®¹ï¼ˆå¯é€‰ï¼Œå¯ç›´æ¥è·³è¿‡ï¼‰';
        }
        
        const recordHintEl = document.getElementById('record-hint');
        const recordContentInputEl = document.getElementById('record-content-input');
        const recordNameLabelEl = document.getElementById('record-name-label');
        const movieRatingSectionEl = document.getElementById('movie-rating-section');
        const movieCommentSectionEl = document.getElementById('movie-comment-section');
        const recordCommentInputEl = document.getElementById('record-comment-input');
        
        if (recordHintEl) recordHintEl.innerText = hintText;
        if (recordContentInputEl) {
            recordContentInputEl.value = '';
            recordContentInputEl.placeholder = isMovie ? 'ä¾‹å¦‚ï¼šã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹' : (item.category === 'è¯»ä¹¦æ¸…å•ğŸ“–' ? 'ä¾‹å¦‚ï¼šã€Šæ´»ç€ã€‹' : 'ä¾‹å¦‚ï¼šä»Šå¤©å’Œä¸€ä½å’–å•¡åº—è€æ¿èŠå¤©');
        }
        if (recordNameLabelEl) recordNameLabelEl.innerText = isMovie ? 'ğŸ¬ ç”µå½±åç§°' : (item.category === 'è¯»ä¹¦æ¸…å•ğŸ“–' ? 'ğŸ“– ä¹¦å' : 'ğŸ“ è®°å½•å†…å®¹');
        
        // æ˜¾ç¤º/éšè—ç”µå½±è¯„åˆ†å’ŒçŸ­è¯„åŒºåŸŸ
        if (movieRatingSectionEl) movieRatingSectionEl.style.display = isMovie ? 'block' : 'none';
        if (movieCommentSectionEl) movieCommentSectionEl.style.display = isMovie ? 'block' : 'none';
        
        // é‡ç½®è¯„åˆ†å’Œè¯„è®º
        this.setMovieRating(0);
        if (recordCommentInputEl) recordCommentInputEl.value = '';
        
        // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤º/éšè—è·³è¿‡æŒ‰é’®ï¼ˆéç”µå½±/ä¹¦ç±ä»»åŠ¡å¯ä»¥è·³è¿‡ï¼‰
        const skipBtn = document.getElementById('record-skip-btn');
        const cancelBtn = document.getElementById('record-cancel-btn');
        const modalEl = document.getElementById('record-modal');
        const inputEl = document.getElementById('record-content-input');
        
        if (skipBtn && cancelBtn) {
            if (mustRecord) {
                // ç”µå½±å’Œä¹¦ç±å¿…é¡»è®°å½•ï¼Œä¸æ˜¾ç¤ºè·³è¿‡æŒ‰é’®
                skipBtn.style.display = 'none';
                cancelBtn.style.flex = '1';
            } else {
                // å…¶ä»–ä»»åŠ¡å¯ä»¥è·³è¿‡ï¼Œæ˜¾ç¤ºè·³è¿‡æŒ‰é’®
                skipBtn.style.display = 'block';
                cancelBtn.style.flex = '0.5';
            }
        }
        
        if (modalEl) {
            modalEl.style.display = 'flex';
        }
        
        if (inputEl) {
            inputEl.focus();
        }
    },
    
    // è·³è¿‡è®°å½•ï¼ˆç›´æ¥å¢åŠ è¿›åº¦ï¼Œä¸è®°å½•å†…å®¹ï¼‰
    skipRecord() {
        const id = this.pendingRecordItemId;
        this.doAddProgress(id, null);
        document.getElementById('record-modal').style.display = 'none';
        this.pendingRecordItemId = null;
        this.currentMovieRating = 0;
    },
    
    // è®¾ç½®ç”µå½±è¯„åˆ†
    setMovieRating(rating) {
        this.currentMovieRating = rating;
        const stars = document.querySelectorAll('.movie-rating-star');
        if (stars.length > 0) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.opacity = '1';
                    star.style.transform = 'scale(1.1)';
                } else {
                    star.style.opacity = '0.3';
                    star.style.transform = 'scale(1)';
                }
            });
        }
    },

    // ç¡®è®¤è®°å½•å†…å®¹
    confirmRecord() {
        const item = this.data.annualPlan.find(p => p.id === this.pendingRecordItemId);
        if (!item) return;
        
        const content = document.getElementById('record-content-input').value.trim();
        const comment = document.getElementById('record-comment-input') ? document.getElementById('record-comment-input').value.trim() : '';
        const rating = this.currentMovieRating || 0;
        
        // ç”µå½±å’Œä¹¦ç±å¿…é¡»å¡«å†™å†…å®¹ï¼Œå…¶ä»–ä»»åŠ¡å¯é€‰
        const mustRecord = item.category === 'ç”µå½±æ¸…å•ğŸ¬' || item.category === 'è¯»ä¹¦æ¸…å•ğŸ“–';
        if (mustRecord && !content) {
            alert('è¯·è¾“å…¥å†…å®¹ï¼');
            return;
        }
        
        // æ„å»ºè®°å½•å¯¹è±¡
        let recordData = null;
        if (content || comment || rating > 0) {
            recordData = {
                content: content || 'å®Œæˆä¸€æ¬¡',
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };
            
            // å¦‚æœæ˜¯ç”µå½±ï¼Œæ·»åŠ è¯„åˆ†å’ŒçŸ­è¯„
            if (this.isMovieRecord) {
                recordData.rating = rating;
                recordData.comment = comment;
            }
        }
        
        const id = this.pendingRecordItemId;
        
        // æ ¹æ®ä»»åŠ¡ç±»å‹åˆ†å‘å¤„ç†é€»è¾‘
        if (item.target > 1) {
            this.doAddProgress(id, recordData);
        } else {
            this.completeSingleItem(id, recordData);
        }
        
        document.getElementById('record-modal').style.display = 'none';
        this.pendingRecordItemId = null;
        this.currentMovieRating = 0;
    },

    // æ‰§è¡Œå¢åŠ è¿›åº¦çš„å®é™…é€»è¾‘
    doAddProgress(id, recordData) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item || item.target <= 1) return;
        
        if (item.current < item.target) {
            item.current++;
            
            // å¦‚æœéœ€è¦è®°å½•å†…å®¹ï¼Œä¿å­˜åˆ°recordsæ•°ç»„
            if (recordData) {
                if (!item.records) {
                    item.records = [];
                }
                // recordData å¯èƒ½æ˜¯å¯¹è±¡ï¼ˆåŒ…å«è¯„åˆ†ã€è¯„è®ºï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                if (typeof recordData === 'string') {
                    item.records.push({
                        content: recordData,
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString()
                    });
                } else {
                    item.records.push(recordData);
                }
            } else {
                // æ²¡æœ‰è®°å½•å†…å®¹ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªç®€å•è®°å½•
                if (!item.records) {
                    item.records = [];
                }
                item.records.push({
                    content: 'å®Œæˆä¸€æ¬¡',
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                });
            }
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (item.current >= item.target) {
                item.completed = true;
                uiManager.createPetal();
                uiManager.createPetal();
                uiManager.createPetal();
                this.showToast(`ğŸ‰ğŸ‰ğŸ‰ å®Œæˆäº†ï¼š${item.name}ï¼å¤ªå‰å®³äº†ï¼`);
            } else {
                const displayContent = recordData ? (recordData.content || 'å®Œæˆä¸€æ¬¡') : 'å®Œæˆä¸€æ¬¡';
                const msg = `å·²è®°å½•ï¼š${displayContent} âœ¨ (${item.current}/${item.target})`;
                this.showToast(msg);
            }
            
            this.saveData();
            this.render();
        }
    },

    // æŸ¥çœ‹è®°å½•åˆ—è¡¨
    viewRecords(id) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item || !item.records || item.records.length === 0) {
            alert('æš‚æ— è®°å½•');
            return;
        }
        
        document.getElementById('records-list-title').innerText = `${item.icon} ${item.name} - å·²å®Œæˆè®°å½•`;
        
        let html = '';
        item.records.forEach((record, index) => {
            html += `
                <div class="record-item">
                    <div class="record-item-content">
                        <div>${index + 1}. ${record.content}</div>
                        <div class="record-item-date">${record.date} ${record.time}</div>
                    </div>
                    <button class="btn-delete-record" onclick="app.deleteRecord(${id}, ${index})" title="åˆ é™¤è®°å½•">ğŸ—‘ï¸</button>
                </div>
            `;
        });
        
        document.getElementById('records-list-content').innerHTML = html || '<div style="text-align:center; padding:20px; color:var(--text-light);">æš‚æ— è®°å½•</div>';
        document.getElementById('records-list-modal').style.display = 'flex';
    },

    // åˆ é™¤è®°å½•
    deleteRecord(itemId, recordIndex) {
        const item = this.data.annualPlan.find(p => p.id === itemId);
        if (!item || !item.records) return;
        
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            item.records.splice(recordIndex, 1);
            // å¦‚æœåˆ é™¤è®°å½•åï¼Œå½“å‰è¿›åº¦åº”è¯¥ç›¸åº”å‡å°‘
            if (item.current > 0) {
                item.current--;
            }
            // å¦‚æœè¿›åº¦å‡å°‘åæœªå®Œæˆï¼Œå–æ¶ˆå®ŒæˆçŠ¶æ€
            if (item.current < item.target) {
                item.completed = false;
            }
            this.saveData();
            this.viewRecords(itemId); // åˆ·æ–°è®°å½•åˆ—è¡¨
            this.render(); // åˆ·æ–°ä¸»åˆ—è¡¨
        }
    },

    // æ›´æ–°æ€»ä½“è¿›åº¦
    updateOverallProgress() {
        const total = this.data.annualPlan.length;
        let totalProgress = 0;
        
        this.data.annualPlan.forEach(item => {
            if (item.completed) {
                totalProgress += 100;
            } else if (item.target > 1) {
                // é˜¶æ®µæ€§ä»»åŠ¡æŒ‰ç™¾åˆ†æ¯”è®¡ç®—
                totalProgress += (item.current / item.target) * 100;
            }
        });
        
        const percent = total > 0 ? Math.round(totalProgress / total) : 0;
        
        // æ›´æ–° SVG è¿›åº¦æ¡
        const circle = document.getElementById('overall-progress-path');
        const textSvg = document.getElementById('overall-progress-text-svg');
        const textMain = document.getElementById('overall-progress-text');
        
        if (circle) {
            // stroke-dasharray: current, 100
            circle.setAttribute('stroke-dasharray', `${percent}, 100`);
        }
        
        if (textSvg) textSvg.textContent = `${percent}%`;
        if (textMain) textMain.innerText = `${percent}%`;
    },

    // æ˜¾ç¤ºæ–°å¢è®¡åˆ’å¼¹çª—
    showAddPlanModal() {
        document.getElementById('add-plan-modal').style.display = 'flex';
        document.getElementById('plan-name-input').value = '';
        document.getElementById('plan-target-input').value = '1';
        document.getElementById('plan-icon-input').value = 'ğŸ“';
        
        // å¦‚æœæœ‰å±•å¼€çš„åˆ†ç±»ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå±•å¼€çš„åˆ†ç±»
        if (this.expandedCategories.size > 0) {
             const firstExpanded = this.expandedCategories.values().next().value;
             if (firstExpanded) {
                 const select = document.getElementById('plan-category-select');
                 // æ£€æŸ¥è¯¥é€‰é¡¹æ˜¯å¦å­˜åœ¨ï¼ˆé˜²æ­¢é»˜è®¤å±•å¼€äº†ä¸å­˜åœ¨çš„åˆ†ç±»ï¼‰
                 let exists = false;
                 for (let i = 0; i < select.options.length; i++) {
                     if (select.options[i].value === firstExpanded) {
                         exists = true;
                         break;
                     }
                 }
                 if (exists) {
                     select.value = firstExpanded;
                 }
             }
        }
        document.getElementById('plan-name-input').focus();
    },

    // åˆ‡æ¢è‡ªå®šä¹‰åˆ†ç±»è¾“å…¥
    toggleCustomCategory(show) {
        const select = document.getElementById('plan-category-select');
        const wrapper = document.getElementById('custom-category-wrapper');
        const input = document.getElementById('custom-category-input');
        
        if (show) {
            select.style.display = 'none';
            wrapper.style.display = 'block';
            input.focus();
        } else {
            select.style.display = 'block';
            wrapper.style.display = 'none';
            select.value = "ä¼‘é—²å¨±ä¹"; // é‡ç½®ä¸ºé»˜è®¤
        }
    },

    // æ·»åŠ æ–°è®¡åˆ’
    addNewPlan() {
        const name = document.getElementById('plan-name-input').value.trim();
        let category = document.getElementById('plan-category-select').value;
        const target = parseInt(document.getElementById('plan-target-input').value) || 1;
        const icon = document.getElementById('plan-icon-input').value.trim() || 'ğŸ“';

        // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰åˆ†ç±»
        const wrapper = document.getElementById('custom-category-wrapper');
        if (wrapper.style.display === 'block') {
            category = document.getElementById('custom-category-input').value.trim();
            if (!category) {
                alert('è¯·è¾“å…¥è‡ªå®šä¹‰åˆ†ç±»åç§°ï¼');
                return;
            }
        }

        if (!name) {
            alert('è¯·è¾“å…¥è®¡åˆ’åç§°ï¼');
            return;
        }

        if (target < 1) {
            alert('ç›®æ ‡æ•°é‡å¿…é¡»å¤§äº0ï¼');
            return;
        }

        // æ·»åŠ åˆ°æ•°æ®
        if (!this.data.annualPlan) {
            this.data.annualPlan = [];
        }

        const newPlan = {
            id: Date.now(),
            category: category,
            name: name,
            target: target,
            current: 0,
            completed: false,
            icon: icon
        };

        this.data.annualPlan.push(newPlan);
        this.saveData();

        // å…³é—­å¼¹çª—
        document.getElementById('add-plan-modal').style.display = 'none';
        
        // ç¡®ä¿æ–°è®¡åˆ’æ‰€å±çš„åˆ†ç±»å·²å±•å¼€
        this.expandedCategories.add(category);
        
        this.showToast('è®¡åˆ’å·²æ·»åŠ ï¼âœ¨');
        this.render();
    },

    // åˆ é™¤è®¡åˆ’
    deletePlan(id) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item) return;

        if (confirm(`ç¡®å®šè¦åˆ é™¤è®¡åˆ’"${item.name}"å—ï¼Ÿ`)) {
            this.data.annualPlan = this.data.annualPlan.filter(p => p.id !== id);
            this.saveData();
            this.showToast('è®¡åˆ’å·²åˆ é™¤');
            this.render();
        }
    },

    // ========== è¯»åæ„ŸåŠŸèƒ½ ==========
    
    // æ˜¾ç¤ºè¯»åæ„Ÿè¾“å…¥å¼¹çª—
    showReviewModal(id, isNewCompletion = false) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item) return;
        
        this.pendingReviewItemId = id;
        this.isEditingReview = !isNewCompletion && item.review && item.review.content;
        
        // è®¾ç½®å¼¹çª—æ ‡é¢˜
        document.getElementById('review-title').innerText = this.isEditingReview ? 'ç¼–è¾‘è¯»åæ„Ÿ' : 'å†™ä¸‹è¯»åæ„Ÿ';
        document.getElementById('review-book-name').innerText = item.name;
        
        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……å·²æœ‰å†…å®¹
        if (this.isEditingReview && item.review) {
            this.setReviewRating(item.review.rating || 0);
            document.getElementById('review-content-input').value = item.review.content || '';
        } else {
            this.setReviewRating(0);
            document.getElementById('review-content-input').value = '';
        }
        
        document.getElementById('review-modal').style.display = 'flex';
        
        // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
            document.getElementById('review-content-input').focus();
        }, 100);
    },

    // è®¾ç½®è¯»åæ„Ÿè¯„åˆ†
    setReviewRating(rating) {
        this.currentReviewRating = rating;
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.style.opacity = '1';
                star.style.transform = 'scale(1.1)';
            } else {
                star.style.opacity = '0.3';
                star.style.transform = 'scale(1)';
            }
        });
    },

    // ä¿å­˜è¯»åæ„Ÿ
    saveReview() {
        const content = document.getElementById('review-content-input').value.trim();
        const rating = this.currentReviewRating;
        
        if (!content && rating === 0) {
            alert('è¯·è‡³å°‘å¡«å†™è¯»åæ„Ÿæˆ–é€‰æ‹©è¯„åˆ†å“¦ï¼');
            return;
        }
        
        const item = this.data.annualPlan.find(p => p.id === this.pendingReviewItemId);
        if (!item) return;
        
        // ä¿å­˜è¯»åæ„Ÿ
        item.review = {
            content: content,
            rating: rating,
            date: new Date().toLocaleDateString(),
            time: new Date().toLocaleTimeString(),
            updatedAt: new Date().toISOString()
        };
        
        this.saveData();
        document.getElementById('review-modal').style.display = 'none';
        this.pendingReviewItemId = null;
        
        uiManager.createPetal();
        this.showToast('è¯»åæ„Ÿå·²ä¿å­˜ï¼ğŸ“âœ¨');
        this.render();
    },

    // è·³è¿‡è¯»åæ„Ÿ
    skipReview() {
        document.getElementById('review-modal').style.display = 'none';
        this.pendingReviewItemId = null;
        this.showToast('å¯ä»¥ç¨åå†å†™è¯»åæ„Ÿå“¦ ğŸ’•');
    },

    // æŸ¥çœ‹è¯»åæ„Ÿ
    viewReview(id) {
        const item = this.data.annualPlan.find(p => p.id === id);
        if (!item || !item.review) {
            alert('æš‚æ— è¯»åæ„Ÿ');
            return;
        }
        
        this.pendingReviewItemId = id;
        
        document.getElementById('view-review-title').innerText = item.name;
        document.getElementById('view-review-date').innerText = `å®Œæˆäº ${item.review.date || 'æœªçŸ¥æ—¥æœŸ'}`;
        
        // æ˜¾ç¤ºè¯„åˆ†
        const ratingHtml = item.review.rating > 0 
            ? 'â­'.repeat(item.review.rating) + `<span style="color:var(--text-light); font-size:0.8rem; margin-left:8px;">${item.review.rating}/5åˆ†</span>`
            : '<span style="color:var(--text-light); font-size:0.85rem;">æš‚æ— è¯„åˆ†</span>';
        document.getElementById('view-review-rating').innerHTML = ratingHtml;
        
        // æ˜¾ç¤ºå†…å®¹
        document.getElementById('view-review-content').innerText = item.review.content || 'æš‚æ— è¯»åæ„Ÿå†…å®¹';
        
        document.getElementById('view-review-modal').style.display = 'flex';
    },

    // ç¼–è¾‘è¯»åæ„Ÿ
    editReview() {
        const id = this.pendingReviewItemId;
        document.getElementById('view-review-modal').style.display = 'none';
        this.showReviewModal(id);
    }
});

app.init();
</script>
</body>
</html>
